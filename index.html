<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINANZAS PRO 6.4</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --bg-alt: #f1f5f9;
            --text-main: #1e293b;
            --border-color: #e2e8f0;
            --input-bg: #ffffff;
            --input-text: #1e293b;
        }

        .dark {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-alt: #334155;
            --text-main: #f1f5f9;
            --border-color: #334155;
            --input-bg: #1e293b;
            --input-text: #f1f5f9;
        }

        body { background-color: var(--bg-main); color: var(--text-main); transition: all 0.2s ease; padding-bottom: 100px; font-family: sans-serif; overflow-x: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; border: 1px solid var(--border-color); }
        .card-alt { background: var(--bg-alt); }

        input, select, textarea { 
            background-color: var(--input-bg) !important; 
            color: var(--input-text) !important; 
            border: 1px solid var(--border-color) !important; 
            border-radius: 12px; height: 48px; padding: 0 12px; font-size: 16px; width: 100%;
        }

        /* Estilo calculadora */
        #calc-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .btn-calc { background: #334155; color: white; height: 60px; border-radius: 12px; font-weight: bold; font-size: 20px; }
        .btn-calc.op { background: #1e40af; }
        .btn-calc.res { background: #10b981; grid-column: span 2; }

        .btn-tipo { background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); height: 40px; width: 100%; border-radius: 8px; font-size: 10px; font-weight: bold; }
        .btn-tipo.active { background-color: #1e40af !important; color: white !important; border-color: #1e40af !important; }
        nav { background: var(--bg-card); border-top: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <header class="p-4 flex justify-between items-center bg-blue-700 text-white shadow-lg mb-2">
        <div>
            <h1 class="text-xl font-black italic uppercase tracking-tighter">Control 2026</h1>
            <p id="mes-actual-label" class="text-[10px] font-bold opacity-80 uppercase"></p>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleDarkMode()" class="text-xl p-2"><i id="dark-icon" class="fas fa-moon"></i></button>
            <select id="filtro-mes" onchange="actualizarUI()" class="!bg-blue-800 !text-white !border-none !h-8 !text-[10px] w-24 font-bold"></select>
        </div>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 flex justify-around p-3 z-50">
        <button onclick="showTab('inicio')" id="nav-inicio" class="flex flex-col items-center text-gray-400 nav-active"><i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 uppercase">Muro</span></button>
        <button onclick="showTab('analisis')" id="nav-analisis" class="flex flex-col items-center text-gray-400"><i class="fas fa-tasks text-xl"></i><span class="text-[9px] mt-1 uppercase">Planes</span></button>
        <button onclick="showTab('graficos')" id="nav-graficos" class="flex flex-col items-center text-gray-400"><i class="fas fa-chart-pie text-xl"></i><span class="text-[9px] mt-1 uppercase">Gr√°ficos</span></button>
        <button onclick="showTab('config')" id="nav-config" class="flex flex-col items-center text-gray-400"><i class="fas fa-cog text-xl"></i><span class="text-[9px] mt-1 uppercase">Ajustes</span></button>
    </nav>

    <div id="calc-modal">
        <div class="bg-slate-800 p-6 rounded-3xl w-full max-w-xs shadow-2xl">
            <div id="calc-display" class="text-right text-white text-3xl font-mono mb-4 p-4 bg-slate-900 rounded-xl overflow-hidden h-16 flex items-center justify-end">0</div>
            <div class="calc-grid">
                <button class="btn-calc" onclick="calcInput('7')">7</button><button class="btn-calc" onclick="calcInput('8')">8</button><button class="btn-calc" onclick="calcInput('9')">9</button><button class="btn-calc op" onclick="calcInput('/')">√∑</button>
                <button class="btn-calc" onclick="calcInput('4')">4</button><button class="btn-calc" onclick="calcInput('5')">5</button><button class="btn-calc" onclick="calcInput('6')">6</button><button class="btn-calc op" onclick="calcInput('*')">√ó</button>
                <button class="btn-calc" onclick="calcInput('1')">1</button><button class="btn-calc" onclick="calcInput('2')">2</button><button class="btn-calc" onclick="calcInput('3')">3</button><button class="btn-calc op" onclick="calcInput('-')">-</button>
                <button class="btn-calc" onclick="calcInput('0')">0</button><button class="btn-calc" onclick="calcInput('.')">.</button><button class="btn-calc op" onclick="calcClear()">C</button><button class="btn-calc op" onclick="calcInput('+')">+</button>
                <button class="btn-calc res" onclick="calcResult()">OK</button>
                <button class="btn-calc bg-red-900" style="grid-column: span 2;" onclick="document.getElementById('calc-modal').style.display='none'">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="inicio" class="tab-content active p-4">
        <div class="card bg-slate-900 text-white border-none shadow-2xl mb-6">
            <p class="text-slate-400 text-[9px] font-bold uppercase tracking-widest mb-1">Resultado Neto</p>
            <h2 id="total-balance" class="text-4xl font-black italic mb-4">0.00 ‚Ç¨</h2>
            <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-4">
                <div><p class="text-[8px] text-green-400 font-bold uppercase italic">Ingresos</p><p class="text-lg font-bold"><span id="res-ing">0</span>‚Ç¨</p></div>
                <div><p class="text-[8px] text-red-400 font-bold uppercase italic">Gastos</p><p class="text-lg font-bold"><span id="res-gas">0</span>‚Ç¨</p></div>
                <div><p class="text-[8px] text-amber-400 font-bold uppercase italic">Compras</p><p class="text-lg font-bold"><span id="res-com">0</span>‚Ç¨</p></div>
                <div><p class="text-[8px] text-emerald-400 font-bold uppercase italic">Inversi√≥n</p><p class="text-lg font-bold"><span id="res-inv">0</span>‚Ç¨</p></div>
            </div>
        </div>

        <div class="card border-t-4 border-blue-600">
            <input type="hidden" id="edit-id">
            <div class="grid grid-cols-4 gap-1 mb-4">
                <button onclick="setTipo('Ingresos')" id="t-Ingresos" class="btn-tipo active">INGRESOS</button>
                <button onclick="setTipo('Gastos')" id="t-Gastos" class="btn-tipo">GASTOS</button>
                <button onclick="setTipo('Compras')" id="t-Compras" class="btn-tipo">COMPRAS</button>
                <button onclick="setTipo('Inversiones')" id="t-Inversiones" class="btn-tipo">INV.</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <input type="date" id="input-fecha" class="font-bold">
                <div class="relative">
                    <input type="number" id="input-monto" placeholder="0.00" class="font-black text-right text-lg text-blue-600 pr-10">
                    <button onclick="document.getElementById('calc-modal').style.display='flex'" class="absolute right-2 top-2 text-blue-400 p-1"><i class="fas fa-calculator"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <select id="select-cat" class="font-bold"></select>
                <select id="select-metodo" class="font-bold">
                    <option value="BANCO">üè¶ BANCO</option><option value="TARJETA">üí≥ TARJETA</option><option value="EFECTIVO">üíµ EFECTIVO</option>
                </select>
            </div>
            <input type="text" id="input-concepto" placeholder="Escribe el concepto..." class="w-full mb-4 !bg-blue-50 dark:!bg-slate-800">
            <button id="btn-guardar" onclick="registrar()" class="w-full bg-blue-700 text-white h-14 rounded-2xl font-black text-xs uppercase shadow-lg">Guardar Movimiento</button>
        </div>
        <div id="lista-movimientos" class="space-y-2 pb-10 mt-4"></div>
    </div>

    <div id="analisis" class="tab-content p-4">
        <h2 class="text-xl font-black mb-6 uppercase italic">Comparativa Planes</h2>
        <div id="analisis-ingresos" class="card border-l-4 border-green-500 mb-6"></div>
        <div id="analisis-gastos" class="card border-l-4 border-red-500 mb-6"></div>
    </div>

    <div id="graficos" class="tab-content p-4">
        <h2 class="text-xl font-black mb-4 uppercase italic text-center text-blue-600">Distribuci√≥n</h2>
        <div class="card p-4 flex flex-col items-center mb-4">
            <h3 class="font-bold text-red-500 text-[10px] uppercase mb-2 italic">Gastos por Categor√≠a</h3>
            <canvas id="chartGastos"></canvas>
        </div>
        <div class="card p-4 flex flex-col items-center">
            <h3 class="font-bold text-green-500 text-[10px] uppercase mb-2 italic">Ingresos por Categor√≠a</h3>
            <canvas id="chartIngresos"></canvas>
        </div>
    </div>

    <div id="config" class="tab-content p-4">
        <h2 class="text-xl font-black mb-4 uppercase text-blue-600">Gesti√≥n de Datos</h2>
        
        <div class="card border-t-4 border-blue-500 mb-6">
            <h3 class="font-bold mb-4 text-xs text-gray-400 uppercase tracking-widest">A√±adir Nueva Categor√≠a</h3>
            <div class="flex flex-col gap-3">
                <div class="flex flex-col"><label class="text-[10px] font-bold ml-2 mb-1 opacity-50">TIPO</label><select id="nueva-cat-tipo"><option value="Gasto">Gasto</option><option value="Ingreso">Ingreso</option></select></div>
                <div class="flex flex-col"><label class="text-[10px] font-bold ml-2 mb-1 opacity-50">NOMBRE</label><input type="text" id="nueva-cat-input" placeholder="Ej: Ocio..."></div>
                <div class="flex flex-col"><label class="text-[10px] font-bold ml-2 mb-1 opacity-50">PRESUPUESTO MENSUAL (‚Ç¨)</label><div class="flex gap-2"><input type="number" id="nueva-cat-pres" placeholder="0.00" class="flex-1"><button onclick="a√±adirCatManual()" class="bg-blue-800 text-white w-14 rounded-xl font-black text-xl shadow-lg">+</button></div></div>
            </div>
            <div id="lista-cats-admin" class="space-y-2 mt-8 border-t pt-4"></div>
        </div>

        <div class="grid grid-cols-2 gap-2 mb-4">
            <button onclick="exportarExcel()" class="bg-emerald-600 text-white p-4 rounded-2xl font-bold text-[10px] uppercase shadow-md"><i class="fas fa-file-excel mb-1 block text-lg"></i>Exportar Excel</button>
            <button onclick="exportarBackup()" class="bg-blue-600 text-white p-4 rounded-2xl font-bold text-[10px] uppercase shadow-md"><i class="fas fa-download mb-1 block text-lg"></i>Crear Backup</button>
        </div>

        <div class="card border-t-4 border-amber-500 mb-6">
            <h3 class="font-bold mb-2 text-xs uppercase text-gray-400">Recuperar Datos</h3>
            <input type="file" id="import-json-file" accept=".json" class="hidden" onchange="importarBackup(event)">
            <button onclick="document.getElementById('import-json-file').click()" class="w-full bg-amber-500 text-white h-12 rounded-xl font-bold text-[10px] uppercase mb-4">Restaurar Backup (.json)</button>
            
            <textarea id="import-area" class="w-full !h-20 text-[10px] p-2 mb-2" placeholder="O pega datos de Excel aqu√≠..."></textarea>
            <button onclick="importarDatos()" class="w-full bg-slate-700 text-white h-10 rounded-xl font-bold text-[10px] uppercase">Procesar Excel Pegado</button>
        </div>

        <button onclick="borrarTodo()" class="w-full p-4 text-red-500 text-[10px] font-bold uppercase italic opacity-50">Resetear Aplicaci√≥n</button>
    </div>

    <script>
        const KEY_CONFIG = 'fin_config_v6_4';
        const KEY_MOVS = 'fin_movs_v6_4';
        const KEY_DARK = 'fin_dark_v6_4';

        let tipoActual = 'Ingresos';
        let config = JSON.parse(localStorage.getItem(KEY_CONFIG)) || { categorias: [] };
        let movimientos = JSON.parse(localStorage.getItem(KEY_MOVS)) || [];
        let calcExpr = "";
        let myChartG, myChartI;

        // CALCULADORA
        function calcInput(v) { calcExpr += v; document.getElementById('calc-display').innerText = calcExpr; }
        function calcClear() { calcExpr = ""; document.getElementById('calc-display').innerText = "0"; }
        function calcResult() {
            try {
                const res = eval(calcExpr);
                document.getElementById('input-monto').value = res.toFixed(2);
                document.getElementById('calc-modal').style.display = 'none';
                calcClear();
            } catch(e) { document.getElementById('calc-display').innerText = "ERROR"; calcExpr = ""; }
        }

        // TEMA Y UI
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem(KEY_DARK, document.body.classList.contains('dark'));
            document.getElementById('dark-icon').className = document.body.classList.contains('dark') ? 'fas fa-sun' : 'fas fa-moon';
            actualizarUI();
        }
        if(localStorage.getItem(KEY_DARK) === 'true') { document.body.classList.add('dark'); document.getElementById('dark-icon').className = 'fas fa-sun'; }

        function actualizarUI() {
            const selectorMes = document.getElementById('filtro-mes');
            const meses = [...new Set(movimientos.map(m => m.fecha.substring(0, 7)))].sort().reverse();
            if (meses.length === 0) meses.push(new Date().toISOString().substring(0, 7));
            const mesSel = selectorMes.value || meses[0];
            selectorMes.innerHTML = meses.map(m => `<option value="${m}" ${m===mesSel?'selected':''}>${m}</option>`).join('');
            document.getElementById('mes-actual-label').innerText = mesSel;

            const filtrados = movimientos.filter(m => m.fecha.startsWith(mesSel));
            let ing=0, gas=0, com=0, inv=0;
            filtrados.forEach(m => {
                if(m.tipo === 'Ingresos') ing += m.monto;
                else if(m.tipo === 'Gastos') gas += m.monto;
                else if(m.tipo === 'Compras') com += m.monto;
                else if(m.tipo === 'Inversiones') inv += m.monto;
            });

            document.getElementById('total-balance').innerText = (ing - gas - com - inv).toFixed(2) + " ‚Ç¨";
            document.getElementById('res-ing').innerText = ing.toLocaleString();
            document.getElementById('res-gas').innerText = gas.toLocaleString();
            document.getElementById('res-com').innerText = com.toLocaleString();
            document.getElementById('res-inv').innerText = inv.toLocaleString();

            document.getElementById('lista-movimientos').innerHTML = filtrados.map(m => `
                <div class="card flex justify-between items-center py-3 mb-1 border-l-4 ${m.tipo==='Ingresos'?'border-green-500':'border-red-400'}">
                    <div class="flex-1">
                        <span class="font-bold text-xs block">${m.concepto}</span>
                        <span class="text-[9px] text-gray-400 font-bold uppercase">${m.cat} ¬∑ ${m.fecha}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-xs">${m.monto.toFixed(2)}‚Ç¨</span>
                        <div class="flex gap-2">
                             <button onclick="cargarEdicion(${m.id})" class="text-blue-500 p-2"><i class="fas fa-pen"></i></button>
                             <button onclick="eliminarMovimiento(${m.id})" class="text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`).join('');

            renderizarPresupuestos(filtrados);
            renderizarGraficos(filtrados);
            renderizarAdminCats();
            actualizarSelectCategorias();
        }

        function renderizarPresupuestos(movs) {
            const renderSeccion = (tipoCat, tipoMov, containerId, titulo) => {
                const container = document.getElementById(containerId);
                const cats = config.categorias.filter(c => c.tipo === tipoCat);
                let totalR = 0, totalP = 0, html = "";
                cats.forEach(cat => {
                    const real = movs.filter(m => m.cat === cat.nombre && (m.tipo === tipoMov || (tipoMov === 'Gastos' && (m.tipo === 'Compras' || m.tipo === 'Inversiones')))).reduce((s, m) => s + m.monto, 0);
                    const plan = cat.presupuesto || 0;
                    totalR += real; totalP += plan;
                    const porc = plan > 0 ? Math.min((real / plan) * 100, 100) : (real > 0 ? 100 : 0);
                    html += `<div class="mb-4">
                        <div class="flex justify-between items-end mb-1"><span class="text-[10px] font-black opacity-70 uppercase">${cat.nombre}</span><span class="text-[10px] font-bold">${real.toFixed(0)}‚Ç¨ / ${plan}‚Ç¨</span></div>
                        <div class="h-2 bg-gray-100 dark:bg-slate-700 rounded-full overflow-hidden"><div class="h-full ${tipoCat==='Ingreso'?'bg-green-500':'bg-blue-600'}" style="width: ${porc}%"></div></div>
                    </div>`;
                });
                container.innerHTML = `<div class="flex justify-between border-b border-gray-100 dark:border-slate-700 pb-2 mb-4"><span class="text-xs font-black uppercase italic text-blue-500">${titulo}</span><span class="text-xs font-black">${totalR.toFixed(0)}‚Ç¨ <small class="opacity-40 font-normal">de ${totalP.toFixed(0)}‚Ç¨</small></span></div>` + (html || "<p class='text-[10px] opacity-40 italic'>Sin datos</p>");
            };
            renderSeccion('Ingreso', 'Ingresos', 'analisis-ingresos', 'Entradas');
            renderSeccion('Gasto', 'Gastos', 'analisis-gastos', 'Salidas');
        }

        function renderizarGraficos(movs) {
            const agrupar = (tipo) => {
                const d = {};
                movs.filter(m => tipo === 'Ingresos' ? m.tipo === 'Ingresos' : (m.tipo!=='Ingresos')).forEach(m => d[m.cat] = (d[m.cat] || 0) + m.monto);
                return d;
            };
            const draw = (canvasId, data, colorScheme, myChartVar) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (canvasId === 'chartGastos' && myChartG) myChartG.destroy();
                if (canvasId === 'chartIngresos' && myChartI) myChartI.destroy();
                const labels = Object.keys(data).map(k => `${k}: ${data[k].toFixed(0)}‚Ç¨`);
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: Object.values(data), backgroundColor: colorScheme, borderWidth: 0 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#94a3b8' : '#1e293b', font: { size: 9, weight: 'bold' } } } } }
                });
            };
            myChartG = draw('chartGastos', agrupar('Gastos'), ['#ef4444','#f59e0b','#3b82f6','#8b5cf6','#ec4899','#06b6d4']);
            myChartI = draw('chartIngresos', agrupar('Ingresos'), ['#10b981','#34d399','#059669','#6ee7b7']);
        }

        function setTipo(t) { tipoActual = t; document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active')); document.getElementById('t-'+t).classList.add('active'); actualizarSelectCategorias(); }
        function actualizarSelectCategorias() { const s = document.getElementById('select-cat'); const f = (tipoActual === 'Ingresos') ? 'Ingreso' : 'Gasto'; const filtradas = config.categorias.filter(c => c.tipo === f); s.innerHTML = filtradas.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join(''); if(filtradas.length === 0) s.innerHTML = '<option value="Varios">Varios</option>'; }

        function registrar() {
            const id = document.getElementById('edit-id').value;
            const m = parseFloat(document.getElementById('input-monto').value);
            const f = document.getElementById('input-fecha').value;
            const c = document.getElementById('select-cat').value || 'Varios';
            const con = document.getElementById('input-concepto').value || "Varios";
            if (!m || !f) return alert("Faltan datos");
            if(id) {
                const idx = movimientos.findIndex(mov => mov.id == id);
                movimientos[idx] = { ...movimientos[idx], tipo: tipoActual, cat: c, monto: m, fecha: f, concepto: con, metodo: document.getElementById('select-metodo').value };
                document.getElementById('edit-id').value = ""; document.getElementById('btn-guardar').innerText = "Guardar Movimiento";
            } else {
                movimientos.unshift({ id: Date.now(), tipo: tipoActual, cat: c, monto: m, fecha: f, concepto: con, metodo: document.getElementById('select-metodo').value });
            }
            document.getElementById('input-monto').value = ''; document.getElementById('input-concepto').value = ''; guardarYRefrescar();
        }

        function cargarEdicion(id) {
            const m = movimientos.find(mov => mov.id === id);
            document.getElementById('edit-id').value = m.id;
            setTipo(m.tipo);
            document.getElementById('input-monto').value = m.monto;
            document.getElementById('input-fecha').value = m.fecha;
            document.getElementById('select-cat').value = m.cat;
            document.getElementById('input-concepto').value = m.concepto;
            document.getElementById('btn-guardar').innerText = "Actualizar Registro";
            showTab('inicio');
        }

        function renderizarAdminCats() { 
            document.getElementById('lista-cats-admin').innerHTML = config.categorias.map((c, i) => `
                <div class="flex justify-between items-center card-alt p-3 rounded-xl mb-2">
                    <div class="flex-1"><span class="text-[8px] font-black uppercase ${c.tipo==='Ingreso'?'text-green-500':'text-red-400'}">${c.tipo}</span><span class="text-sm font-bold block">${c.nombre}</span></div>
                    <div class="flex items-center gap-2"><input type="number" value="${c.presupuesto}" onchange="updatePresupuesto(${i}, this.value)" class="!w-20 !h-8 text-right font-bold !text-xs !bg-transparent"><button onclick="eliminarCat(${i})" class="text-red-300 p-2"><i class="fas fa-trash"></i></button></div>
                </div>`).join(''); 
        }

        function updatePresupuesto(i, v) { config.categorias[i].presupuesto = parseFloat(v)||0; guardarYRefrescar(); }
        function a√±adirCatManual() { const n=document.getElementById('nueva-cat-input').value.trim(); const t=document.getElementById('nueva-cat-tipo').value; const p=parseFloat(document.getElementById('nueva-cat-pres').value)||0; if(n){ config.categorias.push({nombre:n,tipo:t,presupuesto:p}); document.getElementById('nueva-cat-input').value=''; document.getElementById('nueva-cat-pres').value=''; guardarYRefrescar(); } }
        function eliminarCat(i) { if(confirm("¬øBorrar?")){ config.categorias.splice(i,1); guardarYRefrescar(); } }
        function eliminarMovimiento(id) { if(confirm("¬øBorrar?")) { movimientos = movimientos.filter(m => m.id !== id); guardarYRefrescar(); } }
        function showTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active')); document.getElementById('nav-'+t).classList.add('nav-active'); actualizarUI(); }
        function guardarYRefrescar() { localStorage.setItem(KEY_CONFIG, JSON.stringify(config)); localStorage.setItem(KEY_MOVS, JSON.stringify(movimientos)); actualizarUI(); }
        function borrarTodo() { if(confirm("¬øRESET TOTAL?")) { localStorage.clear(); location.reload(); } }

        // BACKUPS Y EXCEL
        function exportarBackup() { 
            const d = JSON.stringify({config, movimientos}); 
            const b = new Blob([d], {type: 'application/json'}); 
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup_finanzas_${new Date().toISOString().slice(0,10)}.json`; a.click(); 
        }

        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.config && data.movimientos) {
                        config = data.config; movimientos = data.movimientos;
                        guardarYRefrescar(); alert("¬°Datos restaurados con √©xito!");
                    }
                } catch(err) { alert("Error al leer el archivo .json"); }
            };
            reader.readAsText(file);
        }

        function exportarExcel() {
            let csv = "Fecha\tTipo\tMetodo\tCategoria\tConcepto\tImporte\n";
            movimientos.forEach(m => {
                csv += `${m.fecha}\t${m.tipo}\t${m.metodo}\t${m.cat}\t${m.concepto}\t${m.monto.toFixed(2).replace('.',',')}\n`;
            });
            const b = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `finanzas_export_${new Date().toISOString().slice(0,10)}.csv`; a.click();
        }

        function importarDatos() {
            const rawData = document.getElementById('import-area').value;
            if(!rawData.trim()) return;
            const filas = rawData.split('\n');
            filas.forEach(fil => {
                const col = fil.split('\t');
                if(col.length >= 11) {
                    const ing = parseFloat(col[9]?.replace('.','').replace(',','.')) || 0;
                    const gas = parseFloat(col[10]?.replace('.','').replace(',','.')) || 0;
                    if(ing>0 || gas>0) {
                        movimientos.push({ id: Date.now()+Math.random(), tipo: ing>0?'Ingresos':'Gastos', cat: col[5]||'Varios', monto: ing||gas, fecha: col[0], concepto: col[6]||'Importado', metodo: 'BANCO' });
                    }
                }
            });
            guardarYRefrescar(); alert("Importaci√≥n finalizada.");
        }

        document.getElementById('input-fecha').valueAsDate = new Date();
        actualizarUI();
    </script>
</body>
</html>
