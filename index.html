<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINANZAS V8.9.6 - RESTAURADA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; padding-bottom: 80px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 12px; }
        .nav-active { color: #2563eb; border-top: 3px solid #2563eb; }
        input, select { border: 1px solid #cbd5e1 !important; border-radius: 8px; height: 40px; padding: 0 10px; width: 100%; font-size: 16px; }
        .btn-tipo { background: #f1f5f9; border: 1px solid #cbd5e1; color: #64748b; height: 38px; border-radius: 8px; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .btn-tipo.active { background: #1e293b !important; color: white !important; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
        th { background: #f8fafc; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body>

    <header class="bg-slate-900 text-white p-4 flex justify-between items-center sticky top-0 z-50">
        <div>
            <h1 class="text-lg font-black italic tracking-tighter uppercase">Finanzas v8.9.6</h1>
            <p id="periodo-label" class="text-[10px] text-slate-400 font-bold uppercase"></p>
        </div>
        <select id="filtro-mes" onchange="actualizarUI()" class="!w-28 !h-8 !bg-slate-800 !text-white !border-none !text-[10px] font-bold uppercase"></select>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around z-50 pb-safe">
        <button onclick="showTab('inicio')" id="nav-inicio" class="flex-1 py-3 text-center nav-active"><i class="fas fa-list-ul text-lg"></i><br><span class="text-[9px] font-bold uppercase">Muro</span></button>
        <button onclick="showTab('analisis')" id="nav-analisis" class="flex-1 py-3 text-center"><i class="fas fa-chart-pie text-lg"></i><br><span class="text-[9px] font-bold uppercase">Planes</span></button>
        <button onclick="showTab('config')" id="nav-config" class="flex-1 py-3 text-center"><i class="fas fa-cog text-lg"></i><br><span class="text-[9px] font-bold uppercase">Ajustes</span></button>
    </nav>

    <div id="inicio" class="tab-content active p-4">
        <div class="card bg-slate-900 text-white border-none mb-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-black uppercase text-slate-400">Disponible Real</span>
                <h2 id="total-disp" class="text-3xl font-black">0.00€</h2>
            </div>
            <div class="grid grid-cols-3 gap-2 border-t border-white/10 pt-3 text-center text-[10px] font-black uppercase">
                <div><p class="text-emerald-400" id="bal-ing">0€</p><span>Ingresos</span></div>
                <div><p class="text-rose-400" id="bal-gas">0€</p><span>Gastos</span></div>
                <div><p class="text-blue-400" id="bal-com">0€</p><span>Compras</span></div>
            </div>
        </div>

        <div id="form-mov" class="card">
            <div class="grid grid-cols-4 gap-1 mb-3">
                <button onclick="setTipo('Ingresos')" id="t-Ingresos" class="btn-tipo active">Ing</button>
                <button onclick="setTipo('Gastos')" id="t-Gastos" class="btn-tipo">Gas</button>
                <button onclick="setTipo('Compras')" id="t-Compras" class="btn-tipo">Com</button>
                <button onclick="setTipo('Inversiones')" id="t-Inversiones" class="btn-tipo">Hucha</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="date" id="in-fecha">
                <input type="number" id="in-importe" placeholder="0.00" class="font-black text-blue-600">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="in-cat" class="text-xs font-bold uppercase"></select>
                <input type="text" id="in-concepto" placeholder="CONCEPTO" class="text-xs font-bold uppercase">
            </div>
            <button onclick="registrar()" class="w-full bg-slate-900 text-white h-10 rounded-lg font-black text-xs uppercase shadow-lg">Guardar Movimiento</button>
        </div>

        <div id="lista-movs" class="space-y-2"></div>
    </div>

    <div id="analisis" class="tab-content p-4 text-center">
        <div class="card"><canvas id="graficoMes"></canvas></div>
        <div id="progreso-cats" class="space-y-3"></div>
    </div>

    <div id="config" class="tab-content p-4">
        <div class="card">
            <h3 class="text-xs font-black uppercase mb-3">Gestión de Categorías (Excel Base)</h3>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <input type="text" id="cat-nombre" placeholder="CATEGORÍA" class="text-xs font-bold uppercase">
                <input type="number" id="cat-pres" placeholder="PRESUPUESTO" class="text-xs font-bold">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <select id="cat-tipo" class="text-xs font-bold"><option value="Ingreso">Ingreso</option><option value="Gasto">Gasto</option><option value="Compra">Compra</option><option value="Inversion">Hucha</option></select>
                <button onclick="añadirCat()" class="bg-blue-600 text-white font-black text-[10px] rounded-lg">AÑADIR</button>
            </div>
            <div id="lista-cats-config" class="overflow-x-auto"></div>
        </div>

        <div class="card grid grid-cols-2 gap-2">
            <button onclick="exportarExcel()" class="bg-emerald-600 text-white py-3 rounded-lg font-black text-[10px] uppercase"><i class="fas fa-file-excel mr-1"></i> Exportar</button>
            <button onclick="document.getElementById('file-excel').click()" class="bg-indigo-600 text-white py-3 rounded-lg font-black text-[10px] uppercase"><i class="fas fa-upload mr-1"></i> Importar</button>
            <input type="file" id="file-excel" class="hidden" onchange="importarExcel(event)">
        </div>
        <button onclick="resetApp()" class="w-full text-rose-500 font-bold text-[9px] uppercase mt-4">Resetear Aplicación</button>
    </div>

    <script>
        const KEY = 'FINANZAS_V8_9_6';
        let db = JSON.parse(localStorage.getItem(KEY)) || { config: [], movimientos: [] };
        let tipoActual = 'Ingresos', chart = null;

        function save() { localStorage.setItem(KEY, JSON.stringify(db)); actualizarUI(); }

        function actualizarUI() {
            const mesSel = document.getElementById('filtro-mes').value || new Date().toISOString().slice(0, 7);
            const movs = db.movimientos.filter(m => m.Fecha.startsWith(mesSel));
            
            const ing = movs.filter(m => m.Tipo === 'Ingresos').reduce((s, m) => s + m.Importe, 0);
            const gas = movs.filter(m => m.Tipo === 'Gastos').reduce((s, m) => s + m.Importe, 0);
            const com = movs.filter(m => m.Tipo === 'Compras').reduce((s, m) => s + m.Importe, 0);
            const aho = movs.filter(m => m.Tipo === 'Inversiones').reduce((s, m) => s + m.Importe, 0);

            document.getElementById('total-disp').innerText = (ing - gas - com - aho).toFixed(2) + "€";
            document.getElementById('bal-ing').innerText = ing.toFixed(0) + "€";
            document.getElementById('bal-gas').innerText = gas.toFixed(0) + "€";
            document.getElementById('bal-com').innerText = com.toFixed(0) + "€";
            document.getElementById('periodo-label').innerText = "Viendo: " + mesSel;

            document.getElementById('lista-movs').innerHTML = movs.map((m, i) => `
                <div class="card py-2 px-3 flex justify-between items-center text-xs">
                    <div>
                        <p class="text-[8px] font-bold text-slate-400">${m.Fecha} • ${m.Categoría}</p>
                        <p class="font-bold uppercase">${m.Concepto}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black">${m.Importe.toFixed(2)}€</span>
                        <button onclick="eliminarMov(${i})" class="text-rose-400"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).reverse().join('');

            renderFiltroMeses(mesSel);
            updateSelectCats();
            renderListaCatsConfig();
            renderChart(gas, com, aho);
        }

        function renderChart(g, c, a) {
            const ctx = document.getElementById('graficoMes').getContext('2d');
            if(chart) chart.destroy();
            chart = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [g, c, a], backgroundColor: ['#fb7185', '#60a5fa', '#818cf8'] }] } });
        }

        function registrar() {
            const imp = parseFloat(document.getElementById('in-importe').value);
            const fec = document.getElementById('in-fecha').value;
            if(!imp || !fec) return;
            db.movimientos.push({
                Fecha: fec, Tipo: tipoActual, Categoría: document.getElementById('in-cat').value,
                Concepto: document.getElementById('in-concepto').value.toUpperCase() || "VARIOS", Importe: imp
            });
            save(); document.getElementById('in-importe').value = "";
        }

        function añadirCat() {
            const nom = document.getElementById('cat-nombre').value.toUpperCase();
            if(!nom) return;
            db.config.push({ nombre: nom, presupuesto: parseFloat(document.getElementById('cat-pres').value)||0, tipo: document.getElementById('cat-tipo').value });
            save(); document.getElementById('cat-nombre').value = "";
        }

        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(db.movimientos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Movimientos");
            XLSX.writeFile(wb, `Finanzas_v896_${new Date().toLocaleDateString()}.xlsx`);
        }

        function importarExcel(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = evt.target.result;
                const workbook = XLSX.read(data, {type: 'binary'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                db.movimientos = XLSX.utils.sheet_to_json(sheet);
                save();
            };
            reader.readAsBinaryString(e.target.files[0]);
        }

        function showTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active')); document.getElementById('nav-'+t).classList.add('nav-active'); }
        function setTipo(t) { tipoActual = t; document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active')); document.getElementById('t-'+t).classList.add('active'); updateSelectCats(); }
        function updateSelectCats() {
            const mapa = { 'Ingresos': 'Ingreso', 'Gastos': 'Gasto', 'Compras': 'Compra', 'Inversiones': 'Inversion' };
            const options = db.config.filter(c => c.tipo === mapa[tipoActual]).map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join('');
            document.getElementById('in-cat').innerHTML = options + '<option value="VARIOS">VARIOS</option>';
        }
        function renderFiltroMeses(act) {
            let meses = [...new Set(db.movimientos.map(m => m.Fecha.slice(0, 7)))].sort().reverse();
            if(!meses.includes(new Date().toISOString().slice(0, 7))) meses.unshift(new Date().toISOString().slice(0, 7));
            document.getElementById('filtro-mes').innerHTML = meses.map(m => `<option value="${m}" ${m===act?'selected':''}>${m}</option>`).join('');
        }
        function renderListaCatsConfig() {
            document.getElementById('lista-cats-config').innerHTML = `<table><tr><th>Cat</th><th>Pres</th><th>Tipo</th></tr>` + 
                db.config.map(c => `<tr><td>${c.nombre}</td><td>${c.presupuesto}</td><td>${c.tipo}</td></tr>`).join('') + `</table>`;
        }
        function eliminarMov(i) { db.movimientos.splice(i,1); save(); }
        function resetApp() { if(confirm("¿RESET?")) { localStorage.clear(); location.reload(); } }

        document.getElementById('in-fecha').valueAsDate = new Date();
        actualizarUI();
    </script>
</body>
</html>
