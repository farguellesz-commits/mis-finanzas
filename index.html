<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINANZAS V13.6 - CLEAN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script> tailwind.config = { darkMode: 'class' } </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; padding-bottom: 110px; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 1.25rem; padding: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 1rem; border: 1px solid #f1f5f9; }
        html.dark .card { background-color: #1e293b; border-color: #334155; color: #e2e8f0; }
        html.dark body { background-color: #0f172a; color: #e2e8f0; }
        input, select { border: 1px solid #e2e8f0 !important; border-radius: 0.75rem; height: 44px; padding: 0 12px; width: 100%; outline: none; font-size: 14px !important; }
        html.dark input, html.dark select { background-color: #334155; border-color: #475569 !important; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-active { color: #3b82f6; border-top: 3px solid #3b82f6; font-weight: 900; background: rgba(59, 130, 246, 0.05); }
        .btn-tipo { background: #f1f5f9; color: #64748b; height: 40px; border-radius: 0.75rem; font-weight: 800; text-transform: uppercase; flex: 1; font-size: 0.7rem; transition: 0.2s; }
        .btn-tipo.active { background: #1e293b !important; color: white !important; transform: scale(1.02); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .card-action-btn { flex: 1; padding: 12px 0; text-align: center; font-size: 14px; transition: background 0.2s; color: #94a3b8; }
        .card-action-btn:hover { background-color: #f8fafc; }
        html.dark .card-action-btn:hover { background-color: #334155; }
        
        /* TOAST STYLES */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; transition: all 0.3s ease; opacity: 0; pointer-events: none; margin-top: -20px; }
        #toast-container.show { opacity: 1; margin-top: 0; }
        .toast-msg { background: rgba(15, 23, 42, 0.95); color: white; padding: 12px 24px; border-radius: 50px; font-size: 12px; font-weight: 800; text-transform: uppercase; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="light">

    <div id="toast-container"><div class="toast-msg"><i class="fas fa-check-circle text-emerald-400"></i> <span id="toast-text">Acción realizada</span></div></div>

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-3">
            <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-yellow-400"><i id="theme-icon" class="fas fa-moon"></i></button>
            <div>
                <h1 class="font-black italic text-xl uppercase text-blue-400 leading-none">V13.6</h1>
                <p id="mes-header" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest"></p>
            </div>
        </div>
        <select id="filtro-mes" onchange="cambiarMes(this.value)" class="!w-32 !h-9 !bg-slate-800 !text-white !text-xs font-black border-none text-center !rounded-full"></select>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur border-t border-slate-200 dark:border-slate-800 flex justify-around z-50 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <button onclick="showTab('muro')" id="nav-muro" class="flex-1 py-3 text-center nav-active"><i class="fas fa-wallet text-lg mb-1"></i><br><span class="text-[9px] uppercase font-black">Muro</span></button>
        <button onclick="showTab('graficos')" id="nav-graficos" class="flex-1 py-3 text-center text-slate-400"><i class="fas fa-chart-line text-lg mb-1"></i><br><span class="text-[9px] uppercase font-black">Gráficos</span></button>
        <button onclick="showTab('huchas')" id="nav-huchas" class="flex-1 py-3 text-center text-slate-400"><i class="fas fa-piggy-bank text-lg mb-1"></i><br><span class="text-[9px] uppercase font-black">Huchas</span></button>
        <button onclick="showTab('config')" id="nav-config" class="flex-1 py-3 text-center text-slate-400"><i class="fas fa-sliders-h text-lg mb-1"></i><br><span class="text-[9px] uppercase font-black">Ajustes</span></button>
    </nav>

    <div id="muro" class="tab-content active p-3 max-w-2xl mx-auto">
        <div class="card bg-slate-900 text-white border-none p-0 overflow-hidden shadow-2xl mb-4">
            <div class="p-5 text-center bg-gradient-to-br from-slate-800 to-slate-950 border-b border-white/5">
                <p class="text-[10px] text-blue-400 uppercase font-black tracking-[0.3em] mb-1">Disponible Real</p>
                <h2 id="disp-real" class="text-4xl font-black tracking-tighter mb-1">0.00€</h2>
            </div>
            <div class="grid grid-cols-2 divide-x divide-y divide-white/10 bg-slate-900 text-center">
                <div class="p-3"><p class="text-[8px] text-emerald-500 font-black uppercase tracking-wider">Ing. Fijos</p><p id="sum-ing-fijo" class="text-emerald-400 font-bold text-sm">0€</p></div>
                <div class="p-3"><p class="text-[8px] text-cyan-400 font-black uppercase tracking-wider">Ing. Extra</p><p id="sum-ing-extra" class="text-cyan-300 font-bold text-sm">0€</p></div>
                <div class="p-3"><p class="text-[8px] text-rose-500 font-black uppercase tracking-wider">Gas. Fijos</p><p id="sum-gas-fijo" class="text-rose-400 font-bold text-sm">0€</p></div>
                <div class="p-3"><p class="text-[8px] text-amber-500 font-black uppercase tracking-wider">Gas. Extra</p><p id="sum-gas-extra" class="text-amber-400 font-bold text-sm">0€</p></div>
            </div>
        </div>

        <button onclick="clonarFijos()" class="w-full bg-blue-100 text-blue-700 py-2.5 rounded-xl text-[10px] font-black uppercase mb-4 border border-blue-200 hover:bg-blue-200 transition-colors"><i class="fas fa-copy mr-2"></i> Clonar Fijos Mes Anterior</button>

        <div class="card border-l-4 border-blue-500 shadow-lg" id="card-form">
            <div class="flex gap-2 mb-3">
                <button onclick="setTipoMuro('Ingreso')" id="t-Ingreso" class="btn-tipo active">Ingreso</button>
                <button onclick="setTipoMuro('Gasto')" id="t-Gasto" class="btn-tipo">Gasto</button>
            </div>
            <div class="flex gap-2 mb-3">
                <div style="width: 48%;"><input type="date" id="in-fecha" class="text-xs font-bold text-slate-600"></div>
                <div style="width: 52%;"><input type="number" step="0.01" id="in-valor" placeholder="0.00 €" class="font-black text-blue-600 text-lg text-right"></div>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="in-cat" onchange="cargarConceptosMuro()" class="font-bold uppercase text-[10px] bg-slate-50"></select>
                    <select id="in-con" class="font-bold uppercase text-[10px] bg-slate-50"></select>
                </div>
                <input type="text" id="in-nota" placeholder="Detalle / Nota (Opcional)" class="font-bold text-[11px] text-slate-600 bg-slate-50">
                <select id="in-pago" class="font-bold uppercase text-[10px] bg-slate-50">
                    <option value="EFECTIVO">Efectivo</option>
                    <option value="DÉBITO">Débito</option>
                    <option value="CRÉDITO">Crédito</option>
                    <option value="TRANSFERENCIA">Transferencia</option>
                </select>
                <div class="flex gap-2">
                    <label class="flex-1 flex items-center justify-center gap-2 bg-indigo-50 p-2 rounded-lg border border-indigo-100 cursor-pointer">
                        <input type="checkbox" id="in-fijo" class="w-4 h-4"><span class="text-[9px] font-black uppercase text-indigo-700">Fijo</span>
                    </label>
                    <label class="flex-1 flex items-center justify-center gap-2 bg-orange-50 p-2 rounded-lg border border-orange-100 cursor-pointer">
                        <input type="checkbox" id="in-extra" class="w-4 h-4"><span class="text-[9px] font-black uppercase text-orange-700">Extra</span>
                    </label>
                </div>
            </div>
            <button onclick="guardarRegistro()" id="btn-guardar" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black text-xs uppercase mt-4 shadow-lg active:scale-95 transition-all">Guardar Movimiento</button>
            <button onclick="cancelarEdicion()" id="btn-cancelar" class="hidden w-full bg-slate-200 text-slate-500 py-3 rounded-xl font-black text-xs uppercase mt-2">Cancelar Edición</button>
        </div>

        <div class="relative mb-3">
            <input type="text" id="search-muro" placeholder="Buscar movimientos..." onkeyup="actualizarUI()" class="w-full !rounded-full shadow-sm border-none bg-white text-sm pl-10">
            <i class="fas fa-search absolute left-4 top-3.5 text-slate-400 text-sm"></i>
        </div>
        
        <div id="lista-movs" class="space-y-3 pb-24"></div>
    </div>

    <div id="graficos" class="tab-content p-4 max-w-2xl mx-auto space-y-4">
        <div class="card h-[350px]">
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 text-center tracking-widest">Comparativa Mensual</h3>
            <div class="h-[280px]"><canvas id="chartApilado"></canvas></div>
        </div>
        <div class="card h-[400px]">
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-2 text-center tracking-widest">Desglose de Gastos (>5%)</h3>
            <div class="h-[320px]"><canvas id="chartDonut"></canvas></div>
        </div>
        <div class="card h-[350px]">
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 text-center tracking-widest">Tendencia 6 Meses</h3>
            <div class="h-[280px]"><canvas id="chartTendencia"></canvas></div>
        </div>
    </div>

    <div id="huchas" class="tab-content p-4 max-w-2xl mx-auto">
        <div class="card border-l-4 border-purple-500">
            <h3 class="text-[10px] font-black text-purple-500 uppercase mb-3">Nueva Meta de Ahorro</h3>
            <div class="flex gap-2 mb-2">
                <input type="text" id="hucha-nombre" placeholder="Nombre" class="font-bold text-xs uppercase">
                <input type="number" id="hucha-meta" placeholder="Meta €" class="font-bold text-xs w-24">
            </div>
            <button onclick="crearHucha()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-black text-[10px] uppercase">Crear Hucha</button>
        </div>
        <div id="lista-huchas" class="space-y-3 pb-24"></div>
    </div>

    <div id="config" class="tab-content p-4 max-w-2xl mx-auto">
        <div class="card bg-blue-50/50">
            <h3 class="text-[10px] font-black text-blue-600 uppercase mb-3 tracking-widest">Presupuestos y Categorías</h3>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <select id="cfg-tipo" class="text-[10px] font-black uppercase"><option value="Ingreso">Ingreso (Fijo)</option><option value="IngresoExtra">Ingreso (Extra)</option><option value="Gasto">Gasto (Fijo)</option><option value="GastoExtra">Gasto (Extra)</option></select>
                <input type="number" id="cfg-imp" placeholder="Presupuesto €" class="text-xs font-bold">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="cfg-cat" placeholder="CATEGORÍA" class="text-[10px] font-black uppercase">
                <input type="text" id="cfg-con" placeholder="CONCEPTO" class="text-[10px] font-black uppercase">
            </div>
            <button onclick="guardarConfig()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-black text-[10px] uppercase shadow">Guardar Presupuesto</button>
        </div>
        
        <div id="lista-config-acordeon" class="space-y-2 mb-8"></div>

        <div class="card border-dashed border-2 border-slate-200 bg-slate-50/50">
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 text-center">Copia de Seguridad y Datos</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <button onclick="exportarTodo()" class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-lg"><i class="fas fa-download mb-1 block text-sm"></i>Backup (XLSX)</button>
                <button onclick="document.getElementById('file-in').click()" class="bg-blue-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-lg"><i class="fas fa-upload mb-1 block text-sm"></i>Restaurar</button>
                <input type="file" id="file-in" class="hidden" accept=".xlsx, .xls, .csv" onchange="importarTodo(event)">
            </div>
            <button onclick="borrarTodo()" class="w-full py-3 text-rose-500 font-black text-[9px] uppercase border border-rose-200 rounded-xl hover:bg-rose-50 transition-colors">Borrar Todos los Datos</button>
        </div>
    </div>

    <div id="modal-hucha" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-5 w-full max-w-xs shadow-2xl">
            <h3 class="font-black text-sm uppercase mb-4 text-center">Vincular a Hucha</h3>
            <div id="modal-hucha-list" class="space-y-2"></div>
            <button onclick="cerrarModalHucha()" class="w-full mt-4 text-[10px] font-black text-slate-400 uppercase">Cerrar</button>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        const DB_KEY = 'FINANZAS_V13_MASTER'; 
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || { movs: [], config: [], huchas: [] };
        
        let migracion = false;
        db.movs.forEach(m => { if(!m.pago) { m.pago = "EFECTIVO"; migracion = true; } });
        if(migracion) { localStorage.setItem(DB_KEY, JSON.stringify(db)); }

        let tipoMuro = 'Ingreso';
        let mesSeleccionado = new Date().toISOString().slice(0, 7);
        let idEditandoMov = null;
        let charts = {};
        let movParaHucha = null;

        function save() { localStorage.setItem(DB_KEY, JSON.stringify(db)); actualizarUI(); renderHuchas(); }
        
        // --- TOAST FUNCTION ---
        function notificar(msg) {
            const toast = document.getElementById('toast-container');
            document.getElementById('toast-text').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // --- MURO ---
        function setTipoMuro(t) { tipoMuro = t; document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active')); document.getElementById('t-'+t).classList.add('active'); actualizarSelectsMuro(); }
        function actualizarSelectsMuro() {
            const cats = [...new Set(db.config.filter(c => c.tipo.includes(tipoMuro)).map(c => c.categoria))].sort();
            document.getElementById('in-cat').innerHTML = `<option value="">CATEGORÍA...</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('in-con').innerHTML = `<option value="">CONCEPTO...</option>`;
            if(!idEditandoMov) document.getElementById('in-valor').value = "";
        }
        function cargarConceptosMuro() {
            const cat = document.getElementById('in-cat').value;
            const cons = db.config.filter(c => c.tipo.includes(tipoMuro) && c.categoria === cat).sort((a,b)=>a.concepto.localeCompare(b.concepto));
            document.getElementById('in-con').innerHTML = `<option value="">CONCEPTO...</option>` + cons.map(c => `<option value="${c.concepto}">${c.concepto}</option>`).join('');
        }

        function guardarRegistro() {
            const val = parseFloat(document.getElementById('in-valor').value);
            const con = document.getElementById('in-con').value;
            if(isNaN(val) || !con) return notificar("Faltan datos obligatorios");
            
            const nuevo = {
                id: idEditandoMov || Date.now().toString(),
                fecha: document.getElementById('in-fecha').value,
                tipo: tipoMuro,
                cat: document.getElementById('in-cat').value,
                con: con,
                nota: document.getElementById('in-nota').value.trim(),
                valor: val,
                pago: document.getElementById('in-pago').value,
                fijo: document.getElementById('in-fijo').checked,
                extra: document.getElementById('in-extra').checked,
                huchaId: null 
            };

            if(idEditandoMov) {
                const old = db.movs.find(m => String(m.id) === String(idEditandoMov));
                if(old) nuevo.huchaId = old.huchaId;
                const idx = db.movs.findIndex(m => String(m.id) === String(idEditandoMov));
                db.movs[idx] = nuevo;
                notificar("Movimiento Actualizado");
            } else {
                db.movs.push(nuevo);
                notificar("Movimiento Guardado");
            }
            cancelarEdicion();
            save();
        }

        function editarMov(id) {
            const m = db.movs.find(x => String(x.id) === String(id));
            if(!m) return;
            idEditandoMov = id;
            
            document.getElementById('in-fecha').value = m.fecha;
            document.getElementById('in-valor').value = m.valor;
            setTipoMuro(m.tipo);
            
            document.getElementById('in-cat').value = m.cat;
            cargarConceptosMuro();
            document.getElementById('in-con').value = m.con;
            document.getElementById('in-nota').value = m.nota || "";
            document.getElementById('in-pago').value = m.pago || 'EFECTIVO';
            document.getElementById('in-fijo').checked = m.fijo;
            document.getElementById('in-extra').checked = m.extra;

            document.getElementById('btn-guardar').innerText = "ACTUALIZAR";
            document.getElementById('btn-guardar').classList.remove('bg-slate-900');
            document.getElementById('btn-guardar').classList.add('bg-emerald-600');
            document.getElementById('btn-cancelar').classList.remove('hidden');
            
            document.getElementById('muro').scrollIntoView({behavior:'smooth'});
        }

        function cancelarEdicion() {
            idEditandoMov = null;
            document.getElementById('in-valor').value = "";
            document.getElementById('in-cat').value = "";
            document.getElementById('in-con').innerHTML = "";
            document.getElementById('in-nota').value = "";
            document.getElementById('in-fijo').checked = false;
            document.getElementById('in-extra').checked = false;
            
            document.getElementById('btn-guardar').innerText = "GUARDAR MOVIMIENTO";
            document.getElementById('btn-guardar').classList.add('bg-slate-900');
            document.getElementById('btn-guardar').classList.remove('bg-emerald-600');
            document.getElementById('btn-cancelar').classList.add('hidden');
        }

        function clonarFijos() {
            const datePasado = new Date(mesSeleccionado + "-01");
            datePasado.setMonth(datePasado.getMonth() - 1);
            const mesPasado = datePasado.toISOString().slice(0, 7);
            
            const fijosAnteriores = db.movs.filter(m => m.fecha.startsWith(mesPasado) && m.fijo);
            if(!fijosAnteriores.length) return notificar("Sin datos mes anterior");
            
            const fijosActuales = db.movs.filter(m => m.fecha.startsWith(mesSeleccionado) && m.fijo);
            let count = 0;
            fijosAnteriores.forEach(m => {
                const yaExiste = fijosActuales.some(actual => actual.cat === m.cat && actual.con === m.con && Math.abs(actual.valor - m.valor) < 0.1);
                if(!yaExiste) {
                    const nuevo = {...m, id: Date.now()+Math.random(), fecha: mesSeleccionado + "-01", nota: ""};
                    if(!nuevo.pago) nuevo.pago = "EFECTIVO";
                    db.movs.push(nuevo);
                    count++;
                }
            });
            if(count > 0) { save(); notificar(`Clonados ${count} fijos`); } 
            else { notificar("Nada nuevo que clonar"); }
        }

        function filtrarMuro(txt) {
            document.getElementById('search-muro').value = txt;
            actualizarUI();
            notificar("Filtro: " + txt);
        }

        function actualizarUI() {
            const meses = [...new Set(db.movs.map(m => m.fecha.slice(0,7)))].sort().reverse();
            const hoy = new Date().toISOString().slice(0,7);
            if(!meses.includes(hoy)) meses.unshift(hoy);
            document.getElementById('filtro-mes').innerHTML = meses.map(m => `<option value="${m}" ${m===mesSeleccionado?'selected':''}>${m}</option>`).join('');
            document.getElementById('mes-header').innerText = mesSeleccionado;

            const q = document.getElementById('search-muro').value.toLowerCase();
            const movsMes = db.movs.filter(m => m.fecha.startsWith(mesSeleccionado) && (m.con.toLowerCase().includes(q) || m.cat.toLowerCase().includes(q) || (m.nota && m.nota.toLowerCase().includes(q))));
            
            const iF = movsMes.filter(m => m.tipo === 'Ingreso' && !m.extra).reduce((s,m)=>s+m.valor,0);
            const iE = movsMes.filter(m => m.tipo === 'Ingreso' && m.extra).reduce((s,m)=>s+m.valor,0);
            const gF = movsMes.filter(m => m.tipo === 'Gasto' && !m.extra).reduce((s,m)=>s+m.valor,0);
            const gE = movsMes.filter(m => m.tipo === 'Gasto' && m.extra).reduce((s,m)=>s+m.valor,0);

            document.getElementById('disp-real').innerText = (iF+iE - (gF+gE)).toFixed(2) + "€";
            document.getElementById('sum-ing-fijo').innerText = iF.toFixed(0) + "€";
            document.getElementById('sum-ing-extra').innerText = iE.toFixed(0) + "€";
            document.getElementById('sum-gas-fijo').innerText = gF.toFixed(0) + "€";
            document.getElementById('sum-gas-extra').innerText = gE.toFixed(0) + "€";

            const sortedMovs = movsMes.sort((a,b) => {
                const dateDiff = new Date(b.fecha) - new Date(a.fecha);
                if (dateDiff !== 0) return dateDiff; 
                return b.id - a.id; 
            });

            document.getElementById('lista-movs').innerHTML = sortedMovs.map(m => `
                <div class="card p-0 overflow-hidden border-l-4 ${m.tipo==='Ingreso'?'border-emerald-500':'border-rose-500'}">
                    <div class="p-3 flex justify-between items-start">
                        <div class="truncate flex-1 pr-2">
                            <div class="flex items-center gap-2 mb-1">
                                <button onclick="filtrarMuro('${m.cat}')" class="text-[9px] font-black text-slate-500 bg-slate-100 px-1.5 rounded uppercase hover:bg-slate-200 cursor-pointer active:scale-95 transition-transform">${m.cat}</button>
                                <span class="text-[10px] text-slate-500 font-bold">${m.fecha.slice(8,10)}/${m.fecha.slice(5,7)}</span>
                            </div>
                            <p class="font-black text-xs uppercase text-slate-700 leading-tight">${m.con}</p>
                            ${m.nota ? `<p class="text-[10px] text-slate-500 italic mt-0.5 truncate"><i class="fas fa-info-circle text-[8px] mr-1"></i>${m.nota}</p>` : ''}
                            <div class="flex gap-2 mt-1.5 flex-wrap">
                                ${m.fijo?'<span class="text-[8px] font-black px-1.5 bg-indigo-50 text-indigo-600 rounded">FIJO</span>':''}
                                ${m.extra?'<span class="text-[8px] font-black px-1.5 bg-orange-50 text-orange-600 rounded">EXTRA</span>':''}
                                ${m.huchaId?'<span class="text-[8px] font-black px-1.5 bg-purple-50 text-purple-600 rounded">HUCHA</span>':''}
                            </div>
                        </div>
                        <div class="text-right whitespace-nowrap">
                            <span class="font-black text-lg block ${m.tipo==='Ingreso'?'text-emerald-600':'text-rose-600'}">${m.valor.toFixed(2)}€</span>
                            <span class="text-[9px] text-slate-400 font-bold uppercase block mt-1">${m.pago}</span>
                        </div>
                    </div>
                    <div class="flex border-t border-slate-100 dark:border-slate-800 divide-x divide-slate-100 dark:divide-slate-800">
                        <button onclick="abrirModalHucha('${m.id}')" class="card-action-btn hover:text-purple-600 group"><i class="fas fa-piggy-bank text-sm group-hover:scale-110 transition-transform"></i></button>
                        <button onclick="editarMov('${m.id}')" class="card-action-btn hover:text-blue-600 group"><i class="fas fa-pencil-alt text-sm group-hover:scale-110 transition-transform"></i></button>
                        <button onclick="borrarMov('${m.id}')" class="card-action-btn hover:text-rose-600 group"><i class="fas fa-trash text-sm group-hover:scale-110 transition-transform"></i></button>
                    </div>
                </div>`).join('');
            
            renderCharts(iF, iE, gF, gE);
        }

        // --- FUNCIONES EXTRA ---
        function crearHucha() { const n = document.getElementById('hucha-nombre').value.toUpperCase(); const m = parseFloat(document.getElementById('hucha-meta').value); if(n && m) { db.huchas.push({id:Date.now(), nombre:n, meta:m, ahorro:0}); save(); notificar("Hucha Creada"); } }
        function abrirModalHucha(mId) { movParaHucha = mId; document.getElementById('modal-hucha').classList.remove('hidden'); document.getElementById('modal-hucha-list').innerHTML = db.huchas.map(h => `<button onclick="vinculaMovHucha(${h.id})" class="w-full p-3 bg-purple-50 text-purple-700 rounded-xl font-bold text-xs uppercase flex justify-between"><span>${h.nombre}</span><span>${h.ahorro}€</span></button>`).join(''); }
        function cerrarModalHucha() { document.getElementById('modal-hucha').classList.add('hidden'); }
        function vinculaMovHucha(hId) { const m = db.movs.find(x => x.id == movParaHucha); const h = db.huchas.find(x => x.id == hId); if(m && h) { m.huchaId = hId; h.ahorro -= m.valor; save(); notificar("Vinculado a Hucha"); } cerrarModalHucha(); }
        function opHucha(id, cant) { const h = db.huchas.find(x=>x.id==id); if(h) { h.ahorro += cant; save(); notificar("Hucha Actualizada"); } }
        function renderHuchas() { const list = document.getElementById('lista-huchas'); list.innerHTML = (db.huchas || []).map(h => { const movs = db.movs.filter(m => m.huchaId == h.id); return `<div class="card p-3"><div class="flex justify-between items-start mb-2"><div><h4 class="font-black text-xs uppercase text-purple-700">${h.nombre}</h4><p class="text-[10px] text-slate-400 font-bold">${h.ahorro.toFixed(0)}€ / ${h.meta}€</p></div><div class="flex gap-1"><button onclick="opHucha(${h.id}, 50)" class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 font-bold text-xs">+50</button><button onclick="borrarHucha(${h.id})" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 text-xs"><i class="fas fa-trash"></i></button></div></div><div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-purple-500" style="width: ${Math.min(100,(h.ahorro/h.meta)*100)}%"></div></div><button onclick="toggleAcc('hdet-${h.id}')" class="mt-3 text-[9px] font-bold text-slate-400 uppercase">Consultar Historial (${movs.length}) <i class="fas fa-chevron-down ml-1"></i></button><div id="acc-hdet-${h.id}" class="accordion-content mt-2 space-y-1">${movs.map(m => `<div class="flex justify-between text-[9px] bg-slate-50 p-1 rounded font-bold text-slate-500 uppercase"><span>${m.fecha.slice(8,10)} ${m.con}</span><span>-${m.valor}€</span></div>`).join('')}</div></div>`; }).join(''); }
        
        function renderTendencia() { const ctx = document.getElementById('chartTendencia'); if(!ctx) return; const labels = []; for(let i=5; i>=0; i--) { const d = new Date(); d.setMonth(d.getMonth()-i); labels.push(d.toISOString().slice(0,7)); } const dataIng = labels.map(m => db.movs.filter(x => x.fecha.startsWith(m) && x.tipo==='Ingreso').reduce((s,x)=>s+x.valor,0)); const dataGas = labels.map(m => db.movs.filter(x => x.fecha.startsWith(m) && x.tipo==='Gasto').reduce((s,x)=>s+x.valor,0)); if(charts.tendencia) charts.tendencia.destroy(); charts.tendencia = new Chart(ctx, { type:'line', data:{ labels, datasets:[{label:'Ingresos', data:dataIng, borderColor:'#10b981', tension:0.3, fill:false}, {label:'Gastos', data:dataGas, borderColor:'#f43f5e', tension:0.3, fill:false}]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom', labels:{boxWidth:10, font:{size:9}}}, datalabels:{display:false} }}}); }

        function renderDonut() {
            const ctx = document.getElementById('chartDonut'); if(!ctx) return;
            const gastosMes = db.movs.filter(m => m.fecha.startsWith(mesSeleccionado) && m.tipo === 'Gasto');
            
            // 1. Calcular total y agrupar por categoría
            let totalGasto = 0;
            const porCat = {};
            gastosMes.forEach(m => { 
                porCat[m.cat] = (porCat[m.cat] || 0) + m.valor; 
                totalGasto += m.valor;
            });
            
            // 2. Separar categorías mayores al 5% y agrupar el resto en OTROS
            const labels = [];
            const data = [];
            let otrosSum = 0;
            const baseColors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899', '#64748b'];
            
            Object.entries(porCat).sort((a,b)=>b[1]-a[1]).forEach(([cat, val]) => {
                if(totalGasto > 0 && (val / totalGasto) < 0.05) {
                    otrosSum += val;
                } else {
                    labels.push(`${cat} ${val.toFixed(0)}€`); // Añadimos el importe al nombre para la leyenda
                    data.push(val);
                }
            });

            if(otrosSum > 0) {
                labels.push(`OTROS ${otrosSum.toFixed(0)}€`);
                data.push(otrosSum);
            }

            // Asignar color Gris fijo si es "OTROS", sino colores normales
            const bgColors = data.map((_, i) => {
                if(labels[i].startsWith("OTROS")) return '#94a3b8'; // Gris Slate 400
                return baseColors[i % baseColors.length];
            });

            if(charts.donut) charts.donut.destroy();
            charts.donut = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors, borderWidth: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '65%',
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 }, padding: 10 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label; // Muestra "CATEGORIA 500€" en tooltip
                                }
                            }
                        },
                        datalabels: { 
                            color: '#fff', font: { weight: 'bold', size: 9 }, 
                            formatter: (v, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (v * 100 / sum).toFixed(0);
                                return percentage > 4 ? percentage + "%" : ""; // Ocultar si es muy pequeño visualmente
                            }
                        }
                    }
                }
            });
        }

        function guardarConfig() { const t = document.getElementById('cfg-tipo').value; const cat = document.getElementById('cfg-cat').value.toUpperCase(); const con = document.getElementById('cfg-con').value.toUpperCase(); const imp = parseFloat(document.getElementById('cfg-imp').value) || 0; if(cat && con) { db.config.push({id:Date.now(), tipo:t, categoria:cat, concepto:con, importe:imp}); save(); notificar("Presupuesto Guardado"); } }
        function renderConfigList() { const list = document.getElementById('lista-config-acordeon'); const grouped = {}; db.config.forEach(c => { if(!grouped[c.categoria]) grouped[c.categoria] = []; grouped[c.categoria].push(c); }); list.innerHTML = Object.keys(grouped).sort().map(cat => { const items = grouped[cat].sort((a,b)=>a.concepto.localeCompare(b.concepto)); return `<div class="card p-0 overflow-hidden mb-2"><button onclick="toggleAcc('cfg-${cat.replace(/\s+/g,'-')}')" class="w-full p-4 flex justify-between bg-slate-50 font-black text-xs uppercase tracking-widest">${cat} <i class="fas fa-chevron-down"></i></button><div id="acc-cfg-${cat.replace(/\s+/g,'-')}" class="accordion-content">${items.map(c => { const gastado = db.movs.filter(m => m.fecha.startsWith(mesSeleccionado) && m.cat === c.categoria && m.con === c.concepto).reduce((s,m)=>s+m.valor,0); const pct = c.importe > 0 ? Math.min(100, (gastado/c.importe)*100) : 0; return `<div class="p-4 border-t border-slate-100"><div class="flex justify-between items-center mb-1"><p class="font-bold text-xs text-slate-700">${c.concepto}</p><span class="text-[9px] font-black ${gastado>c.importe?'text-rose-500':'text-slate-400'}">${gastado.toFixed(0)}€ / ${c.importe}€</span></div><div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${pct>=100?'bg-rose-500':pct>75?'bg-amber-500':'bg-emerald-500'}" style="width:${pct}%"></div></div><button onclick="borrarCfg('${c.id}')" class="mt-2 text-[8px] text-rose-400 font-bold uppercase">Eliminar</button></div>`; }).join('')}</div></div>`; }).join(''); }
        function exportarTodo() { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.movs), "Movimientos"); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.config), "Presupuestos"); if(db.huchas.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.huchas), "Huchas"); XLSX.writeFile(wb, `Backup_Finanzas_V13_${new Date().toISOString().slice(0,10)}.xlsx`); }
        async function importarTodo(e) { try { const f = e.target.files[0]; if(!f) return; const data = await f.arrayBuffer(); const wb = XLSX.read(data); db.movs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); db.config = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]]); if(wb.SheetNames[2]) db.huchas = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[2]]); save(); notificar("Datos Restaurados"); } catch(err) { notificar("Error al importar"); } }
        function borrarTodo() { if(confirm("¿ELIMINAR TODO?")) { localStorage.clear(); location.reload(); } }
        function cambiarMes(m) { mesSeleccionado = m; actualizarUI(); }
        function toggleAcc(id) { const el = document.getElementById('acc-'+id); el.style.maxHeight = el.style.maxHeight ? null : el.scrollHeight + "px"; }
        function borrarMov(id) { if(confirm("¿Borrar?")) { db.movs = db.movs.filter(m => String(m.id) !== String(id)); save(); notificar("Eliminado"); } }
        function borrarCfg(id) { if(confirm("¿Borrar?")) { db.config = db.config.filter(c => String(c.id) !== String(id)); save(); notificar("Eliminado"); } }
        function borrarHucha(id) { if(confirm("¿Borrar?")) { db.huchas = db.huchas.filter(h => h.id != id); save(); notificar("Hucha eliminada"); } }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
        function showTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active')); document.getElementById('nav-'+t).classList.add('nav-active'); 
            if(t==='graficos') { renderTendencia(); renderDonut(); actualizarUI(); } 
            if(t==='huchas') renderHuchas(); 
            if(t==='config') renderConfigList(); 
        }
        function renderCharts(iF, iE, gF, gE) { const ctx = document.getElementById('chartApilado'); if(!ctx) return; if(charts.apilado) charts.apilado.destroy(); charts.apilado = new Chart(ctx, { type:'bar', data:{ labels:['INGRESOS','GASTOS'], datasets:[ { label:'Ordinario', data:[iF, gF], backgroundColor:['#10b981','#f43f5e'], borderRadius:4, stack:'S0' }, { label:'Extra', data:[iE, gE], backgroundColor:['#22d3ee','#f97316'], borderRadius:4, stack:'S0' }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'bottom', labels:{boxWidth:10, font:{size:9}}}, datalabels:{color:'#fff', font:{weight:'bold', size:9}, formatter:(v)=>v>0?v+'€':''}}}}); }

        document.getElementById('in-fecha').valueAsDate = new Date();
        setTipoMuro('Ingreso');
        actualizarUI();
    </script>
</body>
</html>
