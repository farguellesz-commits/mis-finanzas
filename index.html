<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINANZAS V9.6 - FINAL FIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: system-ui, sans-serif; padding-bottom: 100px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 1.25rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .nav-active { color: #2563eb; border-top: 3px solid #2563eb; font-weight: 900; }
        input, select { border: 1px solid #e2e8f0 !important; border-radius: 0.75rem; height: 44px; padding: 0 12px; font-size: 15px; width: 100%; background: #fff; outline: none; }
        input:focus, select:focus { border-color: #3b82f6 !important; ring: 2px #3b82f6; }
        .btn-tipo { background: #f1f5f9; border: 1px solid #e2e8f0; color: #64748b; height: 42px; border-radius: 0.75rem; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
        .btn-tipo.active { background: #1e293b !important; color: white !important; }
        .progress-bar { height: 8px; border-radius: 4px; background: #f1f5f9; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }
    </style>
</head>
<body>

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <div>
            <h1 class="font-black italic text-lg uppercase text-blue-400 leading-none">Finanzas V9.6</h1>
            <p id="mes-header" class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest"></p>
        </div>
        <select id="filtro-mes" onchange="actualizarUI()" class="!w-32 !h-9 !bg-slate-800 !text-white !text-xs font-bold border-none"></select>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around z-50 pb-safe shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <button onclick="showTab('muro')" id="nav-muro" class="flex-1 py-3 text-center nav-active"><i class="fas fa-list-ul text-xl mb-1"></i><br><span class="text-[9px] uppercase font-bold">Muro</span></button>
        <button onclick="showTab('graficos')" id="nav-graficos" class="flex-1 py-3 text-center"><i class="fas fa-chart-pie text-xl mb-1"></i><br><span class="text-[9px] uppercase font-bold">Gr√°ficos</span></button>
        <button onclick="showTab('config')" id="nav-config" class="flex-1 py-3 text-center"><i class="fas fa-cog text-xl mb-1"></i><br><span class="text-[9px] uppercase font-bold">Ajustes</span></button>
    </nav>

    <div id="muro" class="tab-content active p-4">
        <div class="card bg-slate-900 text-white border-none text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-emerald-500"></div>
            <p class="text-[10px] text-slate-400 uppercase font-black mb-1">Saldo Disponible</p>
            <h2 id="disp-real" class="text-4xl font-black mb-3 tracking-tight">0.00‚Ç¨</h2>
            <div class="grid grid-cols-2 gap-4 border-t border-white/10 pt-3">
                <div><p class="text-[9px] text-slate-500 font-bold">INGRESOS</p><p id="sum-ing" class="text-emerald-400 font-bold text-lg">0‚Ç¨</p></div>
                <div><p class="text-[9px] text-slate-500 font-bold">GASTOS</p><p id="sum-gas" class="text-rose-400 font-bold text-lg">0‚Ç¨</p></div>
            </div>
        </div>

        <div class="card border-l-4 border-blue-600" id="card-formulario">
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="setTipo('Ingresos')" id="t-Ingresos" class="btn-tipo active">Ingresos</button>
                <button onclick="setTipo('Gastos')" id="t-Gastos" class="btn-tipo">Gastos</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <input type="date" id="in-fecha">
                <input type="number" id="in-importe" placeholder="0.00 ‚Ç¨" class="font-black text-blue-600 text-lg">
            </div>
            <div class="space-y-3">
                <select id="in-cat" onchange="cargarConceptosMuro()" class="font-bold uppercase text-sm"></select>
                <select id="in-concepto-select" class="font-bold uppercase text-sm"></select>
                <div class="flex items-center gap-2">
                    <select id="in-pago" class="text-xs font-bold uppercase bg-slate-50 flex-1">
                        <option value="BANCO">üè¶ BANCO</option><option value="EFECTIVO">üíµ EFECTIVO</option><option value="TARJETA">üí≥ TARJETA</option>
                    </select>
                    <label class="flex items-center gap-2 bg-indigo-50 px-3 py-2 rounded-lg border border-indigo-100 cursor-pointer">
                        <input type="checkbox" id="in-fijo" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                        <span class="text-[9px] font-black uppercase text-indigo-700">Fijo</span>
                    </label>
                </div>
            </div>
            <button id="btn-guardar" onclick="registrarMovimiento()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-xs uppercase mt-6 shadow-lg active:scale-95 transition-transform">Guardar Movimiento</button>
            <button id="btn-cancelar" onclick="cancelarEdicion()" class="w-full bg-slate-200 text-slate-500 py-2 rounded-lg font-bold text-[10px] uppercase mt-2 hidden">Cancelar Edici√≥n</button>
        </div>

        <div id="lista-movs" class="space-y-2 mt-4 pb-12"></div>
    </div>

    <div id="graficos" class="tab-content p-4">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="card p-3 mb-0 flex flex-col items-center justify-center">
                <p class="text-[9px] font-black text-slate-400 uppercase">Ahorro %</p>
                <h4 id="kpi-ahorro" class="text-xl font-black text-blue-600">0%</h4>
            </div>
            <div class="card p-3 mb-0 flex flex-col items-center justify-center">
                <p class="text-[9px] font-black text-slate-400 uppercase">Gasto Diario</p>
                <h4 id="kpi-diario" class="text-xl font-black text-rose-600">0‚Ç¨</h4>
            </div>
        </div>
        <div class="card">
            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 text-center">Distribuci√≥n</h3>
            <canvas id="chartDoughnut" style="max-height: 200px;"></canvas>
        </div>
        <div class="card">
            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4">Top Categor√≠as (Gastos)</h3>
            <canvas id="chartBars" style="max-height: 250px;"></canvas>
        </div>
        <h3 class="text-[10px] font-black uppercase text-slate-400 mb-2 ml-1">Control Presupuestario</h3>
        <div id="progreso-presupuestos" class="space-y-3 pb-20"></div>
    </div>

    <div id="config" class="tab-content p-4">
        <div class="card bg-indigo-50 border border-indigo-200 mb-6">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-sync-alt"></i></div>
                <h3 class="text-xs font-black uppercase text-indigo-800">Copia Mensual</h3>
            </div>
            <button onclick="clonarFijos()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-black text-[10px] uppercase shadow-md active:scale-95">üì• Clonar Fijos del Mes Anterior</button>
        </div>

        <div class="card border-2 border-slate-100">
            <h3 class="text-xs font-black uppercase mb-4 text-slate-500">Configuraci√≥n R√°pida</h3>
            <div class="space-y-3">
                <select id="cfg-tipo" class="font-bold text-sm"><option value="Ingreso">Tipo: INGRESO</option><option value="Gasto">Tipo: GASTO</option></select>
                <div class="relative">
                    <input list="lista-sugerencias-cat" id="cfg-cat" type="text" placeholder="CATEGOR√çA" class="font-bold uppercase text-sm" oninput="this.value = this.value.toUpperCase()">
                    <datalist id="lista-sugerencias-cat"></datalist>
                </div>
                <input type="text" id="cfg-con" placeholder="CONCEPTO" class="font-bold uppercase text-sm" oninput="this.value = this.value.toUpperCase()">
                <input type="number" id="cfg-imp" placeholder="PRESUPUESTO ‚Ç¨" class="font-bold text-sm">
                <button onclick="guardarNuevaConfig()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-black text-[10px] uppercase">A√±adir</button>
            </div>
        </div>

        <h3 class="text-[10px] font-black uppercase text-slate-400 mb-2 ml-1">Configuraciones</h3>
        <div id="lista-cats-ui" class="space-y-2 mb-24"></div>

        <div class="fixed bottom-[75px] left-4 right-4 bg-slate-900 p-3 rounded-2xl flex gap-2 items-center justify-between z-40 shadow-2xl">
            <div class="flex gap-2">
                <button onclick="exportarExcel()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase">Exportar</button>
                <button onclick="document.getElementById('file-in').click()" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-black text-[10px] uppercase">Importar</button>
            </div>
            <input type="file" id="file-in" class="hidden" onchange="importarExcel(event)">
            <button onclick="borrarTodoElSistema()" class="text-rose-400 p-2"><i class="fas fa-trash-alt"></i></button>
        </div>
    </div>

    <script>
        const KEY = 'SISTEMA_FINANZAS_V9_FINAL';
        let db = JSON.parse(localStorage.getItem(KEY)) || { config: [], movs: [] };
        let tipoMuroActual = 'Ingresos'; 
        let idEdicion = null;
        let charts = { doughnut: null, bars: null };

        function save() { localStorage.setItem(KEY, JSON.stringify(db)); actualizarUI(); }

        // --- MOTOR PRINCIPAL ---
        function actualizarUI() {
            renderizarSelectorMeses();
            const mesSel = document.getElementById('filtro-mes').value || new Date().toISOString().slice(0,7);
            
            // Ordenar por fecha descendente
            db.movs.sort((a, b) => new Date(b.Fecha) - new Date(a.Fecha));

            const movsMes = db.movs.filter(m => m.Fecha.startsWith(mesSel));
            
            // C√°lculos seguros
            const totalIng = movsMes.reduce((s, m) => s + (m.Tipo === 'Ingreso' ? (parseFloat(m.Importe)||0) : 0), 0);
            const totalGas = movsMes.reduce((s, m) => s + (m.Tipo === 'Gasto' ? (parseFloat(m.Importe)||0) : 0), 0);

            document.getElementById('disp-real').innerText = (totalIng - totalGas).toFixed(2) + "‚Ç¨";
            document.getElementById('sum-ing').innerText = totalIng.toFixed(0) + "‚Ç¨";
            document.getElementById('sum-gas').innerText = totalGas.toFixed(0) + "‚Ç¨";
            document.getElementById('mes-header').innerText = mesSel;

            // Renderizar Lista (Coloreando correctamente seg√∫n Tipo real)
            document.getElementById('lista-movs').innerHTML = movsMes.map(m => `
                <div class="card flex justify-between items-center py-3 border-l-4 ${m.Tipo === 'Ingreso' ? 'border-emerald-500':'border-rose-500'}">
                    <div class="truncate mr-2 flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-[8px] font-bold text-slate-400">${m.Fecha.slice(8,10)}</span>
                            <span class="text-[9px] font-black text-blue-500 uppercase tracking-tighter">${m.Categor√≠a}</span>
                            ${m.Fijo ? '<i class="fas fa-sync-alt text-[9px] text-indigo-500 ml-1"></i>' : ''}
                        </div>
                        <p class="font-bold text-slate-800 uppercase text-xs truncate">${m.Concepto}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <p class="font-black text-sm mr-1 ${m.Tipo==='Ingreso'?'text-emerald-600':'text-rose-600'}">${parseFloat(m.Importe).toFixed(2)}‚Ç¨</p>
                        <button onclick="prepararEdicion('${m.ID}')" class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center"><i class="fas fa-pencil-alt text-xs"></i></button>
                        <button onclick="eliminarMovimiento('${m.ID}')" class="w-8 h-8 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>`).join(''); 

            renderizarDashboard(movsMes, totalIng, totalGas, mesSel);
            renderizarListaAjustes();
            actualizarDatalistCats();
        }

        // --- GR√ÅFICOS (FIXED) ---
        function renderizarDashboard(movs, ti, tg, mesSel) {
            const ahorro = ti > 0 ? Math.max(0, ((ti - tg) / ti) * 100) : 0;
            document.getElementById('kpi-ahorro').innerText = ahorro.toFixed(1) + "%";
            const dias = mesSel === new Date().toISOString().slice(0,7) ? new Date().getDate() : 30;
            document.getElementById('kpi-diario').innerText = (tg / dias).toFixed(1) + "‚Ç¨";

            if (charts.doughnut) charts.doughnut.destroy();
            charts.doughnut = new Chart(document.getElementById('chartDoughnut'), {
                type: 'doughnut', 
                data: { labels: ['Ingresos', 'Gastos'], datasets: [{ data: [ti, tg], backgroundColor: ['#10b981', '#f43f5e'], borderWidth: 0 }] }, 
                options: { cutout: '75%', plugins: { legend: { position: 'bottom' } } }
            });

            // Agregaci√≥n de gastos por categor√≠a (Filtrado estricto por Tipo='Gasto')
            const gastoCat = {};
            movs.filter(m => m.Tipo === 'Gasto').forEach(m => { 
                const cat = m.Categor√≠a || "OTROS";
                const val = parseFloat(m.Importe) || 0;
                gastoCat[cat] = (gastoCat[cat] || 0) + val; 
            });
            
            const top = Object.entries(gastoCat).sort((a,b) => b[1]-a[1]).slice(0,5);
            
            if (charts.bars) charts.bars.destroy();
            charts.bars = new Chart(document.getElementById('chartBars'), {
                type: 'bar', 
                data: { labels: top.map(x=>x[0]), datasets: [{ data: top.map(x=>x[1]), backgroundColor: '#3b82f6', borderRadius: 6 }] }, 
                options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { display: false } } } }
            });

            // Barras de Presupuesto
            const configsGasto = db.config.filter(c => c.tipo === 'Gasto');
            const catsUnicas = [...new Set(configsGasto.map(c => c.categoria))].sort();
            
            document.getElementById('progreso-presupuestos').innerHTML = catsUnicas.map(catNombre => {
                const presupuestoTotal = configsGasto.filter(c => c.categoria === catNombre).reduce((sum, c) => sum + (parseFloat(c.importe)||0), 0);
                const gastadoReal = movs.filter(m => m.Categor√≠a === catNombre && m.Tipo === 'Gasto').reduce((sum, m) => sum + (parseFloat(m.Importe)||0), 0);
                
                if (presupuestoTotal === 0 && gastadoReal === 0) return ''; 
                const porc = presupuestoTotal > 0 ? Math.min((gastadoReal / presupuestoTotal) * 100, 100) : (gastadoReal > 0 ? 100 : 0);
                
                return `<div class="card p-3 mb-2 shadow-sm border border-slate-100"><div class="flex justify-between text-[10px] font-black uppercase mb-1"><span>${catNombre}</span><span class="${gastadoReal > presupuestoTotal ? 'text-rose-500' : 'text-slate-600'}">${gastadoReal.toFixed(0)}‚Ç¨ / ${presupuestoTotal}‚Ç¨</span></div><div class="progress-bar"><div class="progress-fill ${gastadoReal > presupuestoTotal ? 'bg-rose-500' : 'bg-blue-500'}" style="width: ${porc}%"></div></div></div>`;
            }).join('');
        }

        // --- IMPORTACI√ìN AVANZADA V9.6 ---
        function exportarExcel() {
            const nombre = prompt("Nombre:", "MisFinanzas");
            if(!nombre) return;
            // Preparamos datos planos para exportar
            const datosExport = db.movs.map(m => ({
                ID: m.ID, Fecha: m.Fecha, Tipo: m.Tipo, Categor√≠a: m.Categor√≠a, Concepto: m.Concepto, 
                Ingresos: m.Tipo === 'Ingreso' ? m.Importe : 0, 
                Gastos: m.Tipo === 'Gasto' ? m.Importe : 0,
                Fijo: m.Fijo ? "SI" : "NO"
            }));
            const ws = XLSX.utils.json_to_sheet(datosExport);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Datos"); XLSX.writeFile(wb, `${nombre}.xlsx`);
        }

        function importarExcel(e) { 
            const f = e.target.files[0]; if(!f) return; 
            const r = new FileReader();
            r.onload = (evt) => {
                const w = XLSX.read(evt.target.result, {type: 'binary'}); 
                const raw = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]]);
                
                if(!confirm(`Se han detectado ${raw.length} filas.\n¬øProceder con la importaci√≥n inteligente?`)) {
                    document.getElementById('file-in').value = ''; return;
                }

                let count = 0;
                raw.forEach(fila => { 
                    // 1. Detecci√≥n Inteligente de Columnas (Case Insensitive)
                    // Buscamos cualquier columna que se llame "Ingresos", "INGRESOS", etc.
                    const valIng = parseFloat(fila['Ingresos'] || fila['INGRESOS'] || fila['ingresos'] || 0);
                    const valGas = parseFloat(fila['Gastos'] || fila['GASTOS'] || fila['gastos'] || 0);
                    const valImp = parseFloat(fila['Importe'] || fila['IMPORTE'] || 0);

                    // 2. Determinaci√≥n del TIPO (Correcci√≥n del error "Todo es Gasto")
                    let tipoFinal = 'Gasto'; 
                    let importeFinal = 0;

                    if (valIng > 0) {
                        tipoFinal = 'Ingreso';
                        importeFinal = valIng;
                    } else if (valGas > 0) {
                        tipoFinal = 'Gasto';
                        importeFinal = valGas;
                    } else if (valImp > 0) {
                        // Si solo hay columna importe, confiamos en la columna Tipo si existe, sino Gasto por defecto
                        const tipoTexto = (fila['Tipo'] || fila['TIPO'] || '').toString().toUpperCase();
                        if(tipoTexto.includes('INGRESO')) tipoFinal = 'Ingreso';
                        importeFinal = valImp;
                    }

                    // 3. Normalizaci√≥n de FECHA (Correcci√≥n del error "Gr√°ficos en blanco")
                    let fechaFinal = new Date().toISOString().slice(0,10);
                    if(fila.Fecha) {
                        if(typeof fila.Fecha === 'number') {
                            // Formato Excel num√©rico
                            fechaFinal = new Date(Math.round((fila.Fecha - 25569) * 86400 * 1000)).toISOString().slice(0,10);
                        } else {
                            // Intentar parsear texto
                            const d = new Date(fila.Fecha);
                            if(!isNaN(d)) fechaFinal = d.toISOString().slice(0,10);
                        }
                    }

                    // 4. Limpieza de Categor√≠as/Conceptos
                    const catClean = (fila.Categor√≠a || fila.Categoria || fila.CATEGORIA || "OTROS").toString().trim().toUpperCase();
                    const conClean = (fila.Concepto || fila.CONCEPTO || "Varios").toString().trim().toUpperCase();

                    // 5. Creaci√≥n del Objeto Movimiento V9.6
                    const nuevoMov = {
                        ID: "IMP-" + Date.now() + Math.random().toString(16).slice(2),
                        Fecha: fechaFinal,
                        Tipo: tipoFinal, // Ingreso o Gasto
                        Categor√≠a: catClean,
                        Concepto: conClean,
                        Importe: importeFinal, // Un solo campo num√©rico
                        Fijo: (fila.Fijo === 'SI' || fila.Fijo === true || fila.Fijo === 'TRUE')
                    };

                    // 6. Generar Configuraci√≥n (Ajustes) si no existe
                    const existeConfig = db.config.find(c => c.categoria === catClean && c.concepto === conClean);
                    if(!existeConfig) {
                        db.config.push({ 
                            id: Date.now() + Math.random(), 
                            tipo: tipoFinal, 
                            categoria: catClean, 
                            concepto: conClean, 
                            importe: 0 
                        });
                    }

                    // Evitar duplicados exactos (Misma fecha, concepto e importe)
                    const duplicado = db.movs.find(m => m.Fecha === nuevoMov.Fecha && m.Concepto === nuevoMov.Concepto && m.Importe === nuevoMov.Importe && m.Tipo === nuevoMov.Tipo);
                    if (!duplicado) {
                        db.movs.push(nuevoMov);
                        count++;
                    }
                }); 
                
                save();
                alert(`¬°√âxito! Se han importado ${count} movimientos.\n\nIMPORTANTE: Verifica que el filtro de MES (arriba a la derecha) coincida con las fechas de tu Excel para ver los gr√°ficos.`);
                document.getElementById('file-in').value = ''; 
            }; 
            r.readAsBinaryString(f);
        }

        // --- FUNCIONES CORE ---
        function clonarFijos() {
            const mesDestinoStr = document.getElementById('filtro-mes').value;
            if(!mesDestinoStr) return alert("Selecciona mes destino.");
            const fd = new Date(mesDestinoStr + "-01");
            const fa = new Date(fd.getFullYear(), fd.getMonth() - 1, 1);
            const mesAnt = fa.toISOString().slice(0, 7);
            const fijos = db.movs.filter(m => m.Fecha.startsWith(mesAnt) && m.Fijo);
            if(fijos.length === 0) return alert(`No hay fijos en ${mesAnt}`);
            if(!confirm(`Copiar ${fijos.length} fijos de ${mesAnt} a ${mesDestinoStr}?`)) return;
            fijos.forEach(m => {
                const dia = m.Fecha.split('-')[2];
                const nf = mesDestinoStr + '-' + dia;
                db.movs.push({ ...m, ID: Date.now()+Math.random(), Fecha: nf });
            });
            save();
        }

        function registrarMovimiento() {
            const f = document.getElementById('in-fecha').value;
            const imp = parseFloat(document.getElementById('in-importe').value);
            const cat = document.getElementById('in-cat').value;
            const con = document.getElementById('in-concepto-select').value;
            const fijo = document.getElementById('in-fijo').checked;

            if(!f || isNaN(imp) || !cat) return alert("Faltan datos");

            const mov = { ID: idEdicion || Date.now().toString(), Fecha: f, Tipo: tipoMuroActual === 'Ingresos' ? 'Ingreso':'Gasto', Categor√≠a: cat, Concepto: con, Importe: imp, Fijo: fijo };

            if (idEdicion) {
                const idx = db.movs.findIndex(m => m.ID === idEdicion);
                if (idx !== -1) db.movs[idx] = mov;
                cancelarEdicion();
            } else {
                db.movs.push(mov);
            }
            save();
            if(!idEdicion) { document.getElementById('in-importe').value = ""; document.getElementById('in-fijo').checked = false; }
        }

        function prepararEdicion(id) {
            const mov = db.movs.find(m => m.ID === id); if (!mov) return;
            idEdicion = id;
            document.getElementById('btn-guardar').innerText = "ACTUALIZAR";
            document.getElementById('btn-guardar').className = "w-full bg-amber-500 text-white py-4 rounded-xl font-black text-xs uppercase mt-6 shadow-lg";
            document.getElementById('btn-cancelar').classList.remove('hidden');
            document.getElementById('card-formulario').classList.add('ring-2', 'ring-amber-400');
            setTipo(mov.Tipo === 'Ingreso' ? 'Ingresos' : 'Gastos');
            setTimeout(() => {
                document.getElementById('in-fecha').value = mov.Fecha; 
                document.getElementById('in-importe').value = mov.Importe; 
                document.getElementById('in-fijo').checked = mov.Fijo;
                // Forzar carga de categor√≠as si es necesario
                const selCat = document.getElementById('in-cat');
                if(!selCat.querySelector(`option[value="${mov.Categor√≠a}"]`)) { let o=document.createElement('option'); o.value=mov.Categor√≠a; o.text=mov.Categor√≠a; selCat.add(o); }
                selCat.value = mov.Categor√≠a; 
                cargarConceptosMuro();
                const selCon = document.getElementById('in-concepto-select');
                if(![...selCon.options].some(o=>o.value===mov.Concepto)){ let o=document.createElement('option'); o.value=mov.Concepto; o.text=mov.Concepto; selCon.add(o); }
                selCon.value = mov.Concepto; 
                document.getElementById('muro').scrollIntoView({behavior:'smooth'});
            }, 50);
        }

        function cancelarEdicion() {
            idEdicion = null; document.getElementById('in-importe').value = ""; document.getElementById('in-fecha').valueAsDate = new Date(); document.getElementById('in-fijo').checked = false;
            document.getElementById('btn-guardar').innerText = "GUARDAR MOVIMIENTO"; document.getElementById('btn-guardar').className = "w-full bg-slate-900 text-white py-4 rounded-xl font-black text-xs uppercase mt-6 shadow-lg";
            document.getElementById('btn-cancelar').classList.add('hidden'); document.getElementById('card-formulario').classList.remove('ring-2', 'ring-amber-400');
        }

        function renderizarSelectorMeses() {
            const fechas = [...new Set(db.movs.map(m => m.Fecha.slice(0, 7)))].sort().reverse();
            const hoy = new Date().toISOString().slice(0, 7); if (!fechas.includes(hoy)) fechas.unshift(hoy);
            const select = document.getElementById('filtro-mes'); const actual = select.value;
            select.innerHTML = fechas.map(f => `<option value="${f}" ${f===actual?'selected':''}>${f}</option>`).join('');
        }
        function guardarNuevaConfig() {
            const tipo = document.getElementById('cfg-tipo').value, cat = document.getElementById('cfg-cat').value.trim().toUpperCase(), con = document.getElementById('cfg-con').value.trim().toUpperCase(), imp = parseFloat(document.getElementById('cfg-imp').value) || 0;
            if(!cat || !con) return alert("Faltan datos");
            db.config.push({ id: Date.now(), tipo, categoria: cat, concepto: con, importe: imp });
            document.getElementById('cfg-con').value = ""; document.getElementById('cfg-imp').value = ""; save(); actualizarSelectsMuro();
        }
        function renderizarListaAjustes() { document.getElementById('lista-cats-ui').innerHTML = db.config.map((c, i) => `<div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center text-[10px] font-bold shadow-sm"><div class="flex-1"><span class="${c.tipo === 'Ingreso' ? 'text-emerald-600':'text-rose-500'} uppercase">${c.tipo}</span> | <span class="text-slate-800 uppercase">${c.categoria}</span><div class="text-slate-400 uppercase mt-0.5">${c.concepto} <span class="text-slate-900 ml-2">${c.importe.toFixed(2)}‚Ç¨</span></div></div><button onclick="db.config.splice(${i},1); save();" class="text-slate-300 hover:text-rose-500 px-2"><i class="fas fa-trash"></i></button></div>`).join(''); }
        function actualizarDatalistCats() { document.getElementById('lista-sugerencias-cat').innerHTML = [...new Set(db.config.map(c => c.categoria))].map(c => `<option value="${c}">`).join(''); }
        function setTipo(t) { tipoMuroActual = t; document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active')); document.getElementById('t-'+t).classList.add('active'); actualizarSelectsMuro(); }
        function actualizarSelectsMuro() {
            const tipoRef = tipoMuroActual === 'Ingresos' ? 'Ingreso' : 'Gasto';
            const cats = [...new Set(db.config.filter(c => c.tipo === tipoRef).map(c => c.categoria))].sort();
            document.getElementById('in-cat').innerHTML = `<option value="" disabled selected>CATEGOR√çA...</option>` + cats.map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="VARIOS">VARIOS</option>`;
            document.getElementById('in-concepto-select').innerHTML = "";
        }
        function cargarConceptosMuro() {
            const cat = document.getElementById('in-cat').value; const tipoRef = tipoMuroActual === 'Ingresos' ? 'Ingreso' : 'Gasto';
            const conceptos = db.config.filter(c => c.tipo === tipoRef && c.categoria === cat);
            document.getElementById('in-concepto-select').innerHTML = conceptos.map(c => `<option value="${c.concepto}">${c.concepto}</option>`).join('');
            if(conceptos.length > 0) document.getElementById('in-importe').value = conceptos[0].importe;
        }
        function eliminarMovimiento(id) { if(confirm("¬øEliminar?")) { db.movs = db.movs.filter(m => m.ID !== id); save(); } }
        function borrarTodoElSistema() { if(confirm("¬øRESET TOTAL?")) { localStorage.clear(); location.reload(); } }
        function showTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active')); document.getElementById('nav-'+t).classList.add('nav-active'); if(t === 'muro') { actualizarSelectsMuro(); cancelarEdicion(); } actualizarUI(); }

        document.getElementById('in-fecha').valueAsDate = new Date();
        actualizarUI();
    </script>
</body>
</html>
