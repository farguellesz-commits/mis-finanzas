<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINANZAS PRO V10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f1f5f9; color: #1e293b; font-family: system-ui, -apple-system, sans-serif; padding-bottom: 90px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 1.25rem; padding: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .nav-btn { color: #94a3b8; flex: 1; text-align: center; padding: 0.75rem 0; font-weight: 700; font-size: 0.65rem; text-transform: uppercase; }
        .nav-active { color: #2563eb; border-top: 3px solid #2563eb; }
        input, select { border: 1px solid #e2e8f0 !important; border-radius: 0.75rem; height: 44px; padding: 0 10px; font-size: 16px; width: 100%; }
        .btn-tipo { background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; height: 42px; border-radius: 0.75rem; font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }
        .btn-tipo.active { background: #1e293b !important; color: white !important; border-color: #1e293b !important; }
    </style>
</head>
<body>

    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <div>
            <h1 class="font-black italic text-xl tracking-tighter uppercase">Finanzas 10.0</h1>
            <p id="label-mes" class="text-[10px] text-slate-400 font-bold uppercase"></p>
        </div>
        <select id="filtro-mes" onchange="actualizarUI()" class="!w-32 !h-9 !bg-slate-800 !border-none !text-white !text-xs font-bold uppercase"></select>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around z-50 pb-safe">
        <button onclick="showTab('muro')" id="nav-muro" class="nav-btn nav-active"><i class="fas fa-wallet text-xl mb-1"></i><br>Muro</button>
        <button onclick="showTab('planes')" id="nav-planes" class="nav-btn"><i class="fas fa-chart-line text-xl mb-1"></i><br>Planes</button>
        <button onclick="showTab('ajustes')" id="nav-ajustes" class="nav-btn"><i class="fas fa-cog text-xl mb-1"></i><br>Ajustes</button>
    </nav>

    <div id="muro" class="tab-content active p-4">
        <div class="card bg-slate-900 text-white border-none mb-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-[10px] font-black uppercase text-slate-400">Disponible Real</p>
                    <h2 id="bal-total" class="text-4xl font-black">0.00‚Ç¨</h2>
                </div>
                <div class="text-right text-emerald-400">
                    <p class="text-[10px] font-black uppercase opacity-60">Ingresos</p>
                    <p id="bal-ing" class="text-xl font-black">0‚Ç¨</p>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 pt-4 border-t border-white/10 text-center">
                <div><p class="text-[9px] font-bold text-slate-400 uppercase">Gastos</p><p id="bal-gas" class="font-black text-rose-400">0‚Ç¨</p></div>
                <div><p class="text-[9px] font-bold text-slate-400 uppercase">Compras</p><p id="bal-com" class="font-black text-blue-400">0‚Ç¨</p></div>
                <div><p class="text-[9px] font-bold text-slate-400 uppercase">Ahorro</p><p id="bal-aho" class="font-black text-indigo-400">0‚Ç¨</p></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="ejecutarFijos()" class="h-12 bg-white rounded-2xl font-black text-[10px] uppercase shadow-sm border border-slate-200"><i class="fas fa-sync text-blue-500 mr-1"></i> Fijos</button>
            <button onclick="gastoRapidoEfectivo()" class="h-12 bg-amber-500 text-white rounded-2xl font-black text-[10px] uppercase shadow-md"><i class="fas fa-bolt mr-1"></i> Gasto Cash</button>
        </div>

        <div id="form-container" class="card border-l-4 border-slate-400">
            <div class="flex justify-between mb-3"><span class="text-[10px] font-black uppercase text-slate-500">Nuevo Movimiento</span><span id="edit-tag" class="hidden text-[9px] bg-amber-500 text-white px-2 py-0.5 rounded font-bold uppercase">Editando</span></div>
            <div class="grid grid-cols-4 gap-1 mb-3">
                <button onclick="setTipo('Ingresos')" id="btn-Ingresos" class="btn-tipo active">Ing</button>
                <button onclick="setTipo('Gastos')" id="btn-Gastos" class="btn-tipo">Gas</button>
                <button onclick="setTipo('Compras')" id="btn-Compras" class="btn-tipo">Com</button>
                <button onclick="setTipo('Inversiones')" id="btn-Inversiones" class="btn-tipo">Hucha</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <input type="date" id="in-fecha">
                <input type="number" id="in-monto" placeholder="0.00" class="font-black text-blue-600 text-lg">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <select id="in-cat" class="font-bold uppercase text-xs"></select>
                <select id="in-pago" class="font-bold uppercase text-xs">
                    <option value="BANCO">üè¶ BANCO</option>
                    <option value="EFECTIVO">üíµ EFECTIVO</option>
                    <option value="TARJETA">üí≥ TARJETA</option>
                </select>
            </div>
            <input type="text" id="in-concepto" placeholder="CONCEPTO" class="mb-3 font-bold uppercase text-xs">
            <button onclick="registrarMovimiento()" class="w-full h-12 bg-slate-900 text-white rounded-2xl font-black uppercase text-xs shadow-lg">Guardar en Muro</button>
        </div>

        <div id="lista-movs" class="space-y-3 mt-6"></div>
    </div>

    <div id="planes" class="tab-content p-4">
        <div class="card flex flex-col items-center">
            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 w-full">Resumen Mensual</h3>
            <div style="height: 200px; width: 200px;"><canvas id="mainChart"></canvas></div>
            <div id="chart-labels" class="flex flex-wrap justify-center gap-3 mt-4"></div>
        </div>
        <div id="plan-bars" class="space-y-4"></div>
    </div>

    <div id="ajustes" class="tab-content p-4">
        <div class="card bg-indigo-900 text-white border-none shadow-xl mb-6">
            <h3 class="text-[10px] font-black uppercase text-indigo-300 mb-3 tracking-widest"><i class="fas fa-piggy-bank"></i> Monitor Hist√≥rico</h3>
            <div id="hucha-monitor" class="space-y-3 text-sm"></div>
        </div>

        <div class="card border-2 border-slate-200">
            <h3 class="text-[10px] font-black uppercase text-slate-500 mb-3 border-b pb-2">Nueva Categor√≠a Fija</h3>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <select id="adj-tipo" class="text-xs font-bold"><option value="Ingreso">Ingreso</option><option value="Gasto">Gasto</option><option value="Compra">Compra</option><option value="Inversion">Hucha</option></select>
                    <input type="text" id="adj-nombre" placeholder="NOMBRE" class="text-xs font-bold uppercase">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="adj-importe" placeholder="IMPORTE ‚Ç¨" class="text-xs font-bold">
                    <input type="number" id="adj-dia" placeholder="D√çA (1-31)" class="text-xs font-bold">
                </div>
                <div class="flex items-center justify-between p-2 bg-slate-50 rounded-xl">
                    <label class="text-[10px] font-black uppercase">¬øCarga Autom√°tica?</label>
                    <input type="checkbox" id="adj-fijo" class="w-6 h-6">
                </div>
                <button onclick="guardarCategoria()" class="w-full bg-slate-900 text-white h-11 rounded-xl font-black text-[10px] uppercase">A√±adir a la Configuraci√≥n</button>
            </div>
        </div>

        <div id="lista-cats" class="mt-4 space-y-2"></div>

        <div class="card mt-6 border border-emerald-200 bg-emerald-50">
            <h3 class="text-[10px] font-black uppercase text-emerald-700 mb-3">Backup & Datos</h3>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportar()" class="h-10 bg-emerald-600 text-white rounded-xl font-bold text-[10px] uppercase">Exportar</button>
                <button onclick="document.getElementById('import-file').click()" class="h-10 bg-blue-600 text-white rounded-xl font-bold text-[10px] uppercase">Importar</button>
            </div>
            <input type="file" id="import-file" class="hidden" onchange="importar(event)">
            <button onclick="resetTotal()" class="w-full mt-4 text-[9px] font-black uppercase text-rose-500 bg-rose-50 py-3 rounded-xl border border-rose-100">Resetear Aplicaci√≥n</button>
        </div>
    </div>

    <script>
        const DB_NAME = "FINANZAS_MASTER_V10";
        let store = JSON.parse(localStorage.getItem(DB_NAME)) || { config: [], movs: [] };
        let currentType = 'Ingresos';
        let editId = null;
        let chartInstance = null;

        function save() { localStorage.setItem(DB_NAME, JSON.stringify(store)); actualizarUI(); }

        function actualizarUI() {
            const mesAct = document.getElementById('filtro-mes').value || new Date().toISOString().slice(0, 7);
            const movsMes = store.movs.filter(m => m.Fecha.startsWith(mesAct));
            
            // L√ìGICA DE BALANCE
            const ing = movsMes.filter(m => m.Tipo === 'Ingresos').reduce((s, m) => s + m.Importe, 0);
            const gas = movsMes.filter(m => m.Tipo === 'Gastos' && !m.Categor√≠a.toUpperCase().includes('HUCHA')).reduce((s, m) => s + m.Importe, 0);
            const com = movsMes.filter(m => m.Tipo === 'Compras' && !m.Categor√≠a.toUpperCase().includes('HUCHA')).reduce((s, m) => s + m.Importe, 0);
            const aho = movsMes.filter(m => m.Tipo === 'Inversiones').reduce((s, m) => s + m.Importe, 0);
            
            const total = ing - gas - com - aho;

            document.getElementById('bal-total').innerText = total.toFixed(2) + "‚Ç¨";
            document.getElementById('bal-ing').innerText = ing.toFixed(0) + "‚Ç¨";
            document.getElementById('bal-gas').innerText = gas.toFixed(0) + "‚Ç¨";
            document.getElementById('bal-com').innerText = com.toFixed(0) + "‚Ç¨";
            document.getElementById('bal-aho').innerText = aho.toFixed(0) + "‚Ç¨";
            document.getElementById('label-mes').innerText = "Periodo: " + mesAct;

            // LISTA MURO
            document.getElementById('lista-movs').innerHTML = movsMes.map(m => `
                <div class="card flex justify-between items-center py-3 border-l-4 ${getBorder(m.Tipo)}">
                    <div class="flex-1 min-w-0">
                        <p class="text-[9px] font-black text-slate-400 uppercase">${m.Fecha} ‚Ä¢ ${m.Categor√≠a}</p>
                        <p class="font-bold text-slate-800 uppercase truncate">${m.Concepto}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <p class="font-black text-sm">${m.Importe.toFixed(2)}‚Ç¨</p>
                        <button onclick="cargarEdicion('${m.id}')" class="text-amber-500 w-8 h-8 bg-amber-50 rounded-full flex items-center justify-center"><i class="fas fa-pencil-alt text-xs"></i></button>
                        <button onclick="borrarMov('${m.id}')" class="text-rose-500 w-8 h-8 bg-rose-50 rounded-full flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                    </div>
                </div>`).join('');

            updateFiltroMeses(mesAct);
            updateSelectCats();
            renderHuchaMonitor();
            renderListaCats();
            renderPlanes(movsMes);
            renderChart(gas, com, aho);
        }

        function renderHuchaMonitor() {
            const huchaNames = [...new Set([...store.config.filter(c => c.nombre.toUpperCase().includes('HUCHA')).map(c => c.nombre), ...store.movs.filter(m => m.Categor√≠a.toUpperCase().includes('HUCHA')).map(m => m.Categor√≠a)])];
            document.getElementById('hucha-monitor').innerHTML = huchaNames.map(name => {
                const entrado = store.movs.filter(m => m.Categor√≠a === name && m.Tipo === 'Inversiones').reduce((s, m) => s + m.Importe, 0);
                const salido = store.movs.filter(m => m.Categor√≠a === name && (m.Tipo === 'Gastos' || m.Tipo === 'Compras')).reduce((s, m) => s + m.Importe, 0);
                const saldo = entrado - salido;
                return `<div class="bg-indigo-800/50 p-3 rounded-xl flex justify-between items-center">
                    <div><p class="text-[10px] font-black uppercase text-indigo-300">${name}</p><p class="text-lg font-black ${saldo < 0 ? 'text-rose-300' : 'text-emerald-400'}">${saldo.toFixed(0)}‚Ç¨</p></div>
                    <div class="text-[8px] font-bold text-right opacity-60">AHORRO: ${entrado}‚Ç¨<br>GASTADO: ${salido}‚Ç¨</div>
                </div>`;
            }).join('');
        }

        function renderPlanes(movs) {
            const configGas = store.config.filter(c => c.tipo === 'Gasto' || c.tipo === 'Compra' || c.tipo === 'Inversion');
            document.getElementById('plan-bars').innerHTML = configGas.map(c => {
                const real = movs.filter(m => m.Categor√≠a === c.nombre).reduce((s, m) => s + m.Importe, 0);
                const porc = c.importe > 0 ? Math.min((real/c.importe)*100, 100) : 0;
                return `<div class="card py-3"><div class="flex justify-between text-[10px] font-black mb-1"><span>${c.nombre}</span><span>${real.toFixed(0)} / ${c.importe}‚Ç¨</span></div>
                    <div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${real > c.importe && c.tipo !== 'Inversion' ? 'bg-rose-500' : 'bg-blue-600'}" style="width:${porc}%"></div></div></div>`;
            }).join('');
        }

        function renderChart(g, c, a) {
            const ctx = document.getElementById('mainChart');
            if(chartInstance) chartInstance.destroy();
            const total = g + c + a;
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: total > 0 ? [g, c, a] : [1], backgroundColor: total > 0 ? ['#fb7185', '#60a5fa', '#818cf8'] : ['#e2e8f0'], borderWidth: 0 }] },
                options: { cutout: '85%', plugins: { legend: { display: false } } }
            });
            document.getElementById('chart-labels').innerHTML = total > 0 ? `
                <span class="text-[10px] font-black text-rose-500">GASTOS: ${((g/total)*100).toFixed(0)}%</span>
                <span class="text-[10px] font-black text-blue-500">COMPRAS: ${((c/total)*100).toFixed(0)}%</span>
                <span class="text-[10px] font-black text-indigo-500">AHORRO: ${((a/total)*100).toFixed(0)}%</span>` : "";
        }

        function registrarMovimiento() {
            const monto = parseFloat(document.getElementById('in-monto').value);
            const fecha = document.getElementById('in-fecha').value;
            if(!monto || !fecha) return alert("Faltan datos");
            if(editId) { store.movs = store.movs.filter(m => m.id !== editId); editId = null; document.getElementById('edit-tag').classList.add('hidden'); }
            store.movs.unshift({ id: Date.now().toString(), Fecha: fecha, Tipo: currentType, Categor√≠a: document.getElementById('in-cat').value, Concepto: document.getElementById('in-concepto').value.toUpperCase() || "VARIOS", Importe: monto, "Forma de Pago": document.getElementById('in-pago').value });
            save(); clearForm();
        }

        function cargarEdicion(id) {
            const m = store.movs.find(x => x.id === id);
            editId = id;
            document.getElementById('in-fecha').value = m.Fecha;
            document.getElementById('in-monto').value = m.Importe;
            document.getElementById('in-concepto').value = m.Concepto;
            setTipo(m.Tipo);
            document.getElementById('edit-tag').classList.remove('hidden');
            showTab('muro'); window.scrollTo(0,0);
        }

        function ejecutarFijos() {
            const mes = document.getElementById('filtro-mes').value;
            store.config.filter(c => c.fijo).forEach(c => {
                const f = `${mes}-${String(c.dia).padStart(2,'0')}`;
                const mapa = { 'Ingreso': 'Ingresos', 'Gasto': 'Gastos', 'Compra': 'Compras', 'Inversion': 'Inversiones' };
                if(!store.movs.some(m => m.Fecha === f && m.Categor√≠a === c.nombre)) {
                    store.movs.push({ id: Date.now().toString() + Math.random(), Fecha: f, Tipo: mapa[c.tipo], Categor√≠a: c.nombre, Concepto: c.nombre, Importe: c.importe, "Forma de Pago": "BANCO" });
                }
            });
            save(); alert("Cargados");
        }

        function updateFiltroMeses(act) {
            let meses = [...new Set(store.movs.map(m => m.Fecha.slice(0, 7)))].sort().reverse();
            const hoy = new Date().toISOString().slice(0, 7);
            if(!meses.includes(hoy)) meses.unshift(hoy);
            document.getElementById('filtro-mes').innerHTML = meses.map(m => `<option value="${m}" ${m===act?'selected':''}>${m}</option>`).join('');
        }

        function updateSelectCats() {
            const mapa = { 'Ingresos': 'Ingreso', 'Gastos': 'Gasto', 'Compras': 'Compra', 'Inversiones': 'Inversion' };
            let cats = store.config.filter(c => c.tipo === mapa[currentType]).map(c => c.nombre);
            if(currentType === 'Gastos' || currentType === 'Compras') {
                cats = [...cats, ...store.config.filter(c => c.nombre.toUpperCase().includes('HUCHA')).map(c => c.nombre)];
            }
            document.getElementById('in-cat').innerHTML = [...new Set(cats)].map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="VARIOS">VARIOS</option>`;
        }

        function renderListaCats() {
            document.getElementById('lista-cats').innerHTML = store.config.map((c, i) => `
                <div class="card py-2 flex justify-between items-center text-xs font-bold uppercase">
                    <span>${c.tipo.slice(0,3)} | ${c.nombre} | ${c.importe}‚Ç¨</span>
                    <button onclick="borrarCat(${i})" class="text-rose-400 p-2"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        }

        function guardarCategoria() {
            const n = document.getElementById('adj-nombre').value.toUpperCase();
            if(!n) return;
            store.config.push({ tipo: document.getElementById('adj-tipo').value, nombre: n, importe: parseFloat(document.getElementById('adj-importe').value)||0, dia: parseInt(document.getElementById('adj-dia').value)||1, fijo: document.getElementById('adj-fijo').checked });
            save(); document.getElementById('adj-nombre').value = "";
        }

        function setTipo(t) { currentType = t; document.querySelectorAll('.btn-tipo').forEach(b => b.classList.remove('active')); document.getElementById('btn-'+t).classList.add('active'); updateSelectCats(); }
        function getBorder(t) { return {'Ingresos':'border-emerald-500','Gastos':'border-rose-500','Compras':'border-blue-500','Inversiones':'border-indigo-500'}[t]; }
        function showTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(t).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active')); document.getElementById('nav-'+t).classList.add('nav-active'); }
        function clearForm() { document.getElementById('in-monto').value = ""; document.getElementById('in-concepto').value = ""; editId = null; }
        function borrarMov(id) { if(confirm("¬øEliminar?")) { store.movs = store.movs.filter(m => m.id !== id); save(); } }
        function borrarCat(i) { store.config.splice(i,1); save(); }
        function resetTotal() { if(confirm("¬øBORRAR TODO?")) { localStorage.clear(); location.reload(); } }
        function exportar() { const ws = XLSX.utils.json_to_sheet(store.movs); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Backup.xlsx"); }
        function importar(e) { const reader = new FileReader(); reader.onload = (ev) => { const imp = XLSX.utils.sheet_to_json(XLSX.read(ev.target.result, {type:'binary'}).Sheets[XLSX.read(ev.target.result, {type:'binary'}).SheetNames[0]]); imp.forEach(n => { if(!store.movs.some(m => m.id === n.id)) store.movs.push(n); }); save(); }; reader.readAsBinaryString(e.target.files[0]); }
        function gastoRapidoEfectivo() { const m = prompt("Importe:"); if(m) { store.movs.unshift({ id: Date.now().toString(), Fecha: new Date().toISOString().slice(0, 10), Tipo: 'Gastos', Categor√≠a: 'VARIOS', Concepto: "GASTO CASH", "Forma de Pago": 'EFECTIVO', Importe: parseFloat(m) }); save(); } }

        document.getElementById('in-fecha').valueAsDate = new Date();
        actualizarUI();
    </script>
</body>
</html>
