<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FINANZAS PRO 6.0</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        .dark {
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
        }

        body { background-color: var(--bg-main); color: var(--text-main); transition: all 0.3s ease; padding-bottom: 100px; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--bg-card); border-radius: 20px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; border: 1px solid var(--border-color); }
        .nav-active { color: #3b82f6; font-weight: 800; }
        .btn-tipo.active { background-color: #1e40af; color: white; border-color: #1e40af; }
        
        input, select, textarea { 
            background: var(--bg-card); 
            color: var(--text-main); 
            border: 1px solid var(--border-color); 
            border-radius: 10px; padding: 8px; font-size: 14px; 
        }
        
        .progress-bg { background-color: var(--border-color); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.4s ease-out; }

        nav { background: var(--bg-card); border-top: 1px solid var(--border-color); }
    </style>
</head>
<body class="">

    <header class="p-4 flex justify-between items-center bg-blue-700 text-white shadow-lg mb-2">
        <div>
            <h1 class="text-xl font-black italic uppercase tracking-tighter">Control 2026</h1>
            <p id="mes-actual-label" class="text-[10px] font-bold opacity-80 uppercase"></p>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleDarkMode()" class="text-xl p-2"><i id="dark-icon" class="fas fa-moon"></i></button>
            <select id="filtro-mes" onchange="actualizarUI()" class="bg-blue-800 text-white border-none text-[10px] font-bold rounded-full px-3 py-1"></select>
        </div>
    </header>

    <nav class="fixed bottom-0 left-0 right-0 flex justify-around p-3 z-50">
        <button onclick="showTab('inicio')" id="nav-inicio" class="flex flex-col items-center text-gray-400 nav-active"><i class="fas fa-wallet text-xl"></i><span class="text-[9px] mt-1 uppercase">Muro</span></button>
        <button onclick="showTab('analisis')" id="nav-analisis" class="flex flex-col items-center text-gray-400"><i class="fas fa-tasks text-xl"></i><span class="text-[9px] mt-1 uppercase">Planes</span></button>
        <button onclick="showTab('graficos')" id="nav-graficos" class="flex flex-col items-center text-gray-400"><i class="fas fa-chart-pie text-xl"></i><span class="text-[9px] mt-1 uppercase">Gr√°ficos</span></button>
        <button onclick="showTab('config')" id="nav-config" class="flex flex-col items-center text-gray-400"><i class="fas fa-cog text-xl"></i><span class="text-[9px] mt-1 uppercase">Ajustes</span></button>
    </nav>

    <div id="inicio" class="tab-content active p-4">
        <div class="card bg-slate-900 text-white border-none shadow-2xl mb-6 relative overflow-hidden">
            <p class="text-slate-400 text-[9px] font-bold uppercase tracking-widest mb-1">Resultado Neto Mensual</p>
            <h2 id="total-balance" class="text-4xl font-black italic mb-4">0.00 ‚Ç¨</h2>
            <div class="grid grid-cols-2 gap-y-3 gap-x-4 border-t border-white/10 pt-4">
                <div><p class="text-[8px] text-green-400 font-bold uppercase italic">Ingresos</p><p class="text-lg font-bold"><span id="res-ing">0</span>‚Ç¨</p></div>
                <div><p class="text-[8px] text-red-400 font-bold uppercase italic">Gastos</p><p class="text-lg font-bold"><span id="res-gas">0</span>‚Ç¨</p></div>
            </div>
        </div>

        <div class="card border-t-4 border-blue-600">
            <input type="hidden" id="edit-id">
            <div class="grid grid-cols-4 gap-1 mb-4">
                <button onclick="setTipo('Ingresos')" id="t-Ingresos" class="btn-tipo p-2 rounded-lg bg-gray-50 dark:bg-slate-700 border text-[8px] font-bold">INGRESOS</button>
                <button onclick="setTipo('Gastos')" id="t-Gastos" class="btn-tipo active p-2 rounded-lg bg-gray-50 dark:bg-slate-700 border text-[8px] font-bold">GASTOS</button>
                <button onclick="setTipo('Compras')" id="t-Compras" class="btn-tipo p-2 rounded-lg bg-gray-50 dark:bg-slate-700 border text-[8px] font-bold">COMPRAS</button>
                <button onclick="setTipo('Inversiones')" id="t-Inversiones" class="btn-tipo p-2 rounded-lg bg-gray-50 dark:bg-slate-700 border text-[8px] font-bold">INV.</button>
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <input type="date" id="input-fecha" class="text-xs font-bold">
                <input type="number" id="input-monto" placeholder="0.00 ‚Ç¨" class="font-black text-right text-lg text-blue-500">
            </div>
            <div class="grid grid-cols-2 gap-2 mb-3">
                <select id="select-cat" class="font-bold text-xs"></select>
                <select id="select-metodo" class="font-bold text-xs">
                    <option value="BANCO">üè¶ BANCO</option>
                    <option value="TARJETA">üí≥ TARJETA</option>
                    <option value="EFECTIVO">üíµ EFECTIVO</option>
                </select>
            </div>
            <input type="text" id="input-concepto" placeholder="Concepto..." class="w-full p-3 bg-blue-50 dark:bg-slate-800 rounded-xl mb-4 text-sm font-medium border-none">
            <button id="btn-guardar" onclick="registrar()" class="w-full bg-blue-700 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg">Guardar Movimiento</button>
        </div>
        
        <div id="lista-movimientos" class="space-y-2 pb-10 mt-4"></div>
    </div>

    <div id="analisis" class="tab-content p-4">
        <h2 class="text-xl font-black mb-6 uppercase italic">Presupuestos</h2>
        <div id="analisis-ingresos" class="card border-l-4 border-green-500 mb-6"></div>
        <div id="analisis-gastos" class="card border-l-4 border-red-500 mb-6"></div>
    </div>

    <div id="graficos" class="tab-content p-4">
        <h2 class="text-xl font-black mb-6 uppercase italic text-center">Distribuci√≥n del Dinero</h2>
        <div class="card p-6 mb-6">
            <h3 class="text-center font-bold text-red-500 text-xs uppercase mb-4">Origen de Gastos</h3>
            <canvas id="chartGastos"></canvas>
        </div>
        <div class="card p-6 mb-6">
            <h3 class="text-center font-bold text-green-500 text-xs uppercase mb-4">Origen de Ingresos</h3>
            <canvas id="chartIngresos"></canvas>
        </div>
    </div>

    <div id="config" class="tab-content p-4">
        <h2 class="text-xl font-black mb-4 uppercase text-blue-600">Configuraci√≥n</h2>
        <div class="card border-t-4 border-green-600 mb-6">
            <h3 class="font-bold mb-1 text-xs uppercase">Importar 12 Columnas</h3>
            <textarea id="import-area" rows="3" class="w-full text-[10px] p-2 mb-2" placeholder="Pega aqu√≠ desde el Excel..."></textarea>
            <button onclick="importarDatos()" class="w-full bg-green-600 text-white py-2 rounded-xl font-bold text-[10px] uppercase">Cargar Excel</button>
        </div>

        <div class="card">
            <h3 class="font-bold mb-4 text-xs text-gray-400 uppercase">Gesti√≥n de Categor√≠as</h3>
            <div id="lista-cats-admin" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
            <div class="p-4 bg-blue-50 dark:bg-slate-800 rounded-2xl border border-dashed border-blue-200">
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <select id="nueva-cat-tipo" class="text-[10px] font-bold"><option value="Gasto">Gasto</option><option value="Ingreso">Ingreso</option></select>
                    <input type="text" id="nueva-cat-input" placeholder="Nombre..." class="text-xs">
                </div>
                <div class="flex gap-2">
                    <input type="number" id="nueva-cat-pres" placeholder="Pto ‚Ç¨" class="flex-1 text-xs">
                    <button onclick="a√±adirCatManual()" class="bg-blue-800 text-white px-6 rounded-xl font-bold">+</button>
                </div>
            </div>
        </div>
        
        <button onclick="exportarBackup()" class="w-full mt-4 p-3 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-[10px] font-bold rounded-xl uppercase">Backup .JSON</button>
        <button onclick="borrarTodo()" class="w-full mt-2 p-3 text-red-400 text-[10px] font-bold uppercase italic">Reset Completo</button>
    </div>

    <script>
        const KEY_CONFIG = 'fin_config_v6';
        const KEY_MOVS = 'fin_movs_v6';
        const KEY_DARK = 'fin_dark_v6';

        let tipoActual = 'Gastos';
        let config = JSON.parse(localStorage.getItem(KEY_CONFIG)) || { categorias: [] };
        let movimientos = JSON.parse(localStorage.getItem(KEY_MOVS)) || [];
        let myChartG, myChartI;

        // --- MODO OSCURO ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem(KEY_DARK, isDark);
            document.getElementById('dark-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            if(myChartG) actualizarUI(); // Refrescar colores de gr√°ficos
        }
        if(localStorage.getItem(KEY_DARK) === 'true') toggleDarkMode();

        // --- IMPORTACI√ìN 12 COLUMNAS ---
        function importarDatos() {
            const rawData = document.getElementById('import-area').value;
            if(!rawData.trim()) return;
            const filas = rawData.split('\n');
            let contador = 0;
            filas.forEach(fil => {
                if(!fil.trim()) return;
                const col = fil.split('\t');
                if(col.length >= 11) {
                    const fechaRaw = col[0].trim();
                    const categoria = col[5] ? col[5].trim() : 'Varios';
                    const concepto = col[6] ? col[6].trim() : 'Sin concepto';
                    const limpiarNum = (v) => v ? parseFloat(v.trim().replace(/\./g, '').replace(',', '.')) || 0 : 0;
                    const ingMonto = limpiarNum(col[9]);
                    const gasMonto = limpiarNum(col[10]);
                    let montoFinal = 0, tipoFinal = '';
                    if(ingMonto > 0) { montoFinal = ingMonto; tipoFinal = 'Ingresos'; }
                    else if(gasMonto > 0) { montoFinal = gasMonto; tipoFinal = 'Gastos'; }
                    if(montoFinal > 0) {
                        let fechaFinal = fechaRaw;
                        if(fechaRaw.includes('/')) {
                            const p = fechaRaw.split('/');
                            if(p[2]) fechaFinal = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                        }
                        movimientos.push({ id: Date.now()+Math.random(), tipo: tipoFinal, cat: categoria, monto: montoFinal, fecha: fechaFinal, concepto: concepto, metodo: 'BANCO' });
                        contador++;
                    }
                }
            });
            if(contador > 0) { alert(`Importados ${contador} registros.`); document.getElementById('import-area').value = ''; guardarYRefrescar(); }
        }

        // --- N√öCLEO DE LA UI ---
        function actualizarUI() {
            const selectorMes = document.getElementById('filtro-mes');
            const meses = [...new Set(movimientos.map(m => m.fecha.substring(0, 7)))].sort().reverse();
            if (meses.length === 0) meses.push(new Date().toISOString().substring(0, 7));
            const mesSel = selectorMes.value || meses[0];
            selectorMes.innerHTML = meses.map(m => `<option value="${m}" ${m===mesSel?'selected':''}>${m}</option>`).join('');
            document.getElementById('mes-actual-label').innerText = mesSel;

            const filtrados = movimientos.filter(m => m.fecha.startsWith(mesSel));
            let ing=0, gas=0, com=0, inv=0;
            filtrados.forEach(m => {
                if(m.tipo === 'Ingresos') ing += m.monto;
                else if(m.tipo === 'Gastos') gas += m.monto;
                else if(m.tipo === 'Compras') com += m.monto;
                else if(m.tipo === 'Inversiones') inv += m.monto;
            });

            document.getElementById('total-balance').innerText = (ing - gas - com - inv).toFixed(2) + " ‚Ç¨";
            document.getElementById('res-ing').innerText = ing.toLocaleString();
            document.getElementById('res-gas').innerText = (gas + com + inv).toLocaleString();

            document.getElementById('lista-movimientos').innerHTML = filtrados.map(m => `
                <div class="card flex justify-between items-center py-3 mb-1 border-l-4 ${m.tipo==='Ingresos'?'border-green-500':'border-red-400'}">
                    <div class="flex-1">
                        <span class="font-bold text-xs block">${m.concepto}</span>
                        <span class="text-[9px] text-gray-400 font-bold uppercase">${m.cat} ¬∑ ${m.fecha}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-black text-xs">${m.monto.toFixed(2)}‚Ç¨</span>
                        <button onclick="eliminarMovimiento(${m.id})" class="text-red-200 p-1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');

            renderizarPresupuestos(filtrados);
            renderizarGraficos(filtrados);
            renderizarAdminCats();
            actualizarSelectCategorias();
        }

        // Pesta√±a An√°lisis: Listas de Progreso
        function renderizarPresupuestos(movs) {
            const renderSeccion = (tipoCat, tipoMov, containerId, titulo) => {
                const container = document.getElementById(containerId);
                const cats = config.categorias.filter(c => c.tipo === tipoCat);
                let totalR = 0, totalP = 0, html = "";
                
                cats.forEach(cat => {
                    const real = movs.filter(m => m.cat === cat.nombre && (m.tipo === tipoMov || (tipoMov === 'Gastos' && (m.tipo === 'Compras' || m.tipo === 'Inversiones')))).reduce((s, m) => s + m.monto, 0);
                    const plan = cat.presupuesto || 0;
                    totalR += real; totalP += plan;
                    const porc = plan > 0 ? Math.min((real / plan) * 100, 100) : (real > 0 ? 100 : 0);
                    html += `<div class="mb-4">
                        <div class="flex justify-between items-end mb-1"><span class="text-[10px] font-black opacity-70 uppercase">${cat.nombre}</span><span class="text-[10px] font-bold">${real.toFixed(0)}‚Ç¨ / ${plan}‚Ç¨</span></div>
                        <div class="progress-bg"><div class="progress-fill ${tipoCat==='Ingreso'?'bg-green-500':'bg-blue-600'}" style="width: ${porc}%"></div></div>
                    </div>`;
                });
                container.innerHTML = `<div class="flex justify-between border-b border-gray-100 dark:border-slate-700 pb-2 mb-4">
                    <span class="text-xs font-black uppercase italic text-blue-500">${titulo}</span>
                    <span class="text-xs font-black">${totalR.toFixed(0)}‚Ç¨ <small class="opacity-40">de ${totalP}‚Ç¨</small></span>
                </div>` + (html || "<p class='text-[10px] opacity-40 italic'>Sin categor√≠as</p>");
            };
            renderSeccion('Ingreso', 'Ingresos', 'analisis-ingresos', 'Entradas');
            renderSeccion('Gasto', 'Gastos', 'analisis-gastos', 'Salidas');
        }

        // Pesta√±a Gr√°ficos: Chart.js
        function renderizarGraficos(movs) {
            const agrupar = (tipo) => {
                const data = {};
                movs.filter(m => tipo === 'Ingresos' ? m.tipo === 'Ingresos' : (m.tipo==='Gastos'||m.tipo==='Compras'||m.tipo==='Inversiones'))
                    .forEach(m => data[m.cat] = (data[m.cat] || 0) + m.monto);
                return data;
            };

            const draw = (canvasId, data, colorScheme) => {
